<!doctype html> 
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>NextPlayer‚Ñ¢ ‚Äì Scouting App</title>

  <!-- PWA & Mobil -->
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#050608" />
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" type="image/png" sizes="192x192" href="NextPlayer-192.png" />
  <link rel="apple-touch-icon" href="NextPlayer-512.png" />

  <style>
   #sec-ranking {
  border: 2px solid red !important;
}

    :root {
      --np-bg: #050608;
      --np-card: #ffffff;
      --np-accent: #f5b642;
      --np-text: #111111;
      --np-muted: #666666;
    }

    * { box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0;
      padding: 0;
      background: #f1f1f1;
      color: var(--np-text);
    }
   
    .radar-tab {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid #ccc;
      background: #eee;
      cursor: pointer;
      font-size: 0.85rem;
    }

    .radar-tab.active {
      background: var(--np-accent);
      border-color: var(--np-accent);
      color: #111;
      font-weight: 600;
    }

    .card {
      background: #ffffff;
      border-radius: 6px;
      padding: 16px;
      margin: 16px 0;
      box-shadow: 0 1px 3px rgba(0,0,0,0.12);
    }

    .card-section h3 {
      margin-top: 0;
    }
    
    /* Neues Panel-Layout f√ºr Live-Aktionen */
    .radar-panel {
      display: none;              /* wird per JS auf block gesetzt */
      margin-top: 10px;
      border-top: 1px solid #eee;
      padding: 12px 14px;
      border-radius: 10px;
      transition: background-color 0.2s ease;
    }

    .radar-player-label {
      font-weight: 600;
      margin-bottom: 8px;
    }
/* --- Radar: Klarere Struktur & Boxen --- */

/* Intro-Text im Radar etwas dezenter */
#sec-radar p {
  margin-top: 4px;
  margin-bottom: 10px;
  font-size: 0.85rem;
  color: var(--np-muted);
}

/* Die ersten Zeilen (Event & Spieler) als Filter-Box hervorheben */
#sec-radar .row:nth-of-type(1),
#sec-radar .row:nth-of-type(2) {
  background: #fafafa;
  border-radius: 6px;
  padding: 6px 8px;
}

/* Radar-Tabs mit etwas Luft nach oben/unten */
#sec-radar .radar-tab {
  margin-top: 4px;
}

/* Panel f√ºr Live-Aktionen als eigene ‚ÄûKarte‚Äú */
#sec-radar .radar-panel {
  margin-top: 10px;
  background: #ffffff;
  border-radius: 10px;
  border: 1px solid #e0e0e0;
  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
  padding: 10px 12px;
}

/* Label im Panel hervorheben (falls benutzt) */
#sec-radar .radar-player-label {
  font-weight: 600;
  margin-bottom: 6px;
}

    /* --- Radar Live-Aktionen: bessere Bedienbarkeit --- */

.radar-action-row {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 8px 16px;
  margin-bottom: 10px;
}

.radar-cat {
  display: flex;
  align-items: center;
  min-width: 150px;
  font-weight: 600;
}

.radar-cat-icon {
  font-size: 1.2rem;
  margin-right: 6px;
}

.radar-buttons {
  display: flex;
  gap: 8px;
}

.radar-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  border-radius: 999px;
  padding: 6px 12px;
  font-size: 0.9rem;
  border: 1px solid transparent;
  cursor: pointer;
  min-width: 90px;
}

/* gr√ºnes Plus */
.radar-btn-plus {
  background: #e6f7ea;
  color: #1b7a2f;
  border-color: #1b7a2f;
}
.radar-btn-plus::before {
  content: 'Ôºã';
  font-weight: 700;
  margin-right: 4px;
}

/* rotes Minus */
.radar-btn-minus {
  background: #fde7e7;
  color: #b32020;
  border-color: #b32020;
}
.radar-btn-minus::before {
  content: '‚àí';
  font-weight: 700;
  margin-right: 4px;
}

.radar-btn:active {
  transform: translateY(1px);
}

.radar-netto {
  font-size: 0.8rem;
  color: var(--np-muted);
}

    #pl-search-results button {
  border-radius: 6px;
  border: 1px solid #ddd;
  background: #fff;
}
#pl-search-results button:hover {
  background: #f7f7f7;
}
    
/* Kleine Hinweise im Radar etwas einheitlicher */
#sec-radar .small-note {
  font-size: 0.8rem;
  color: var(--np-muted);
}

    .small-note {
      font-size: 0.85rem;
      color: var(--np-muted);
    }

    #radar-panel.active {
      background: rgba(245, 182, 66, 0.10); /* leichter Goldschimmer */
      border-top-color: var(--np-accent);
    }

    header {
      background: linear-gradient(135deg, #000000, #151515);
      color: #fff;
      padding: 14px 18px 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.35);
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    header h1 {
      margin: 0;
      font-size: 1.3rem;
      letter-spacing: 0.03em;
    }

    header .subtitle {
      margin: 4px 0 0;
      font-size: 0.8rem;
      color: #c0c0c0;
    }

    .top-nav {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .top-nav button {
      border: 1px solid rgba(255,255,255,0.3);
      background: rgba(0,0,0,0.4);
      color: #f5f5f5;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 0.75rem;
      cursor: pointer;
      white-space: nowrap;
    }

    .top-nav button.active {
      background: var(--np-accent);
      border-color: var(--np-accent);
      color: #111;
      font-weight: 600;
    }

    main {
      padding: 16px;
      max-width: 1100px;
      margin: 0 auto 40px;
    }

    .section-card {
      background: var(--np-card);
      border-radius: 10px;
      padding: 14px 14px 16px;
      margin-bottom: 16px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
      border: 1px solid rgba(0,0,0,0.04);
    }

    .section-card h2 {
      margin-top: 0;
      padding-bottom: 4px;
      border-bottom: 2px solid rgba(0,0,0,0.06);
      font-size: 1rem;
    }

    .section-card h2 span {
      border-left: 4px solid var(--np-accent);
      padding-left: 6px;
    }

    h3 {
      margin-top: 14px;
      margin-bottom: 6px;
      font-size: 0.95rem;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
    }

    label {
      display: inline-block;
      min-width: 140px;
      font-size: 0.9rem;
    }

    input, select, textarea, button {
      padding: 4px 6px;
      font-size: 0.9rem;
    }

    input, select, textarea {
      border-radius: 4px;
      border: 1px solid #ccc;
    }

    button {
      border-radius: 4px;
      border: 1px solid #ccc;
      cursor: pointer;
      background: #f3f3f3;
    }

    button.primary {
      background: var(--np-accent);
      border-color: var(--np-accent);
      color: #111;
      font-weight: 600;
    }

    textarea {
      width: 100%;
      max-width: 600px;
      min-height: 60px;
    }

    .status-line {
      margin-top: 5px;
      font-size: 0.8rem;
      color: var(--np-muted);
    }

    #criteria > div {
      margin-bottom: 6px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      max-width: 900px;
      background: #fff;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 4px 6px;
      font-size: 0.8rem;
      text-align: left;
    }

    th {
      background: #f5f5f5;
    }

    .fav-toggle {
      cursor: pointer;
      font-size: 1rem;
    }
  
    .jersey-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #111;
      color: #fff;
      font-size: 0.75rem;
      font-weight: 600;
    }

    @media (max-width: 700px) {
      main { padding: 10px; }
      label { min-width: 110px; }
      .row { gap: 6px; }
      header h1 { font-size: 1.1rem; }
    }
  </style>
</head>
<body>
  <header>
    <h1>NextPlayer‚Ñ¢ ‚Äì Scouting App</h1>
    <div class="subtitle">Bewertungen sammeln, Ranking sehen, Talente entdecken.</div>

    <div class="top-nav">
  <button data-target="sec-config"  class="active">üõ†Ô∏è Setup</button>
  <button data-target="sec-auth">üîë Login</button>
  <button data-target="sec-profile">üë§ Profil</button>
  <button data-target="sec-rating">‚öΩ Spieler & Events</button>
  <button data-target="sec-rating-form">‚≠ê Bewertung</button>
  <button data-target="sec-radar">üì° Radar</button>
  <button data-target="sec-ranking">üìä Ranking</button>
  <button data-target="sec-events">üìÖ Events</button>
  <button data-target="sec-last">üïí Verlauf</button>
</div>
  </header>

  <main>

    <!-- 1. Supabase-Konfiguration -->
    <section id="sec-config" class="section-card">
      <h2><span>1. Supabase-Konfiguration</span></h2>
      <div class="row">
        <label for="sb-url">Supabase URL</label>
        <input id="sb-url" type="text" size="40" placeholder="https://xxxx.supabase.co">
      </div>
      <div class="row">
        <label for="sb-key">Anon Key</label>
        <input id="sb-key" type="text" size="60" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...">
      </div>
      <div class="row">
        <button id="btn-save-conf">Speichern</button>
        <button id="btn-test-conf">Verbindung testen</button>
      </div>
      <div id="conf-msg" class="status-line"></div>
    </section>

    <!-- 2. Login / Registrierung -->
    <section id="sec-auth" class="section-card">
      <h2><span>2. Login / Registrierung</span></h2>

      <h3>Login & Grunddaten</h3>
      <div class="row">
        <label for="auth-email">E-Mail</label>
        <input id="auth-email" type="email" size="30">
      </div>
      <div class="row">
        <label for="auth-pass">Passwort</label>
        <input id="auth-pass" type="password" size="20">
      </div>

      <h3>Nur f√ºr Registrierung (Konto anlegen)</h3>
      <div class="row">
        <label for="reg-nick">K√ºnstlername</label>
        <input id="reg-nick" type="text" size="20" placeholder="z.B. NextLeo10">
      </div>
      <div class="row">
        <label for="reg-year">Geburtsjahr</label>
        <input id="reg-year" type="number" min="2000" max="2100" size="6" placeholder="z.B. 2010">
      </div>
      <div class="row">
        <label for="reg-parent-email">Eltern-E-Mail</label>
        <input id="reg-parent-email" type="email" size="30" placeholder="Pflicht bei U16, optional sonst">
      </div>
      <div class="row">
        <label for="reg-role">Rolle</label>
        <select id="reg-role">
          <option value="">Bitte w√§hlen‚Ä¶</option>
          <option value="spieler">Aktiver Spieler</option>
          <option value="trainer">Trainer</option>
          <option value="scout">Scout</option>
          <option value="eltern">Elternteil</option>
          <option value="zuschauer">Zuschauer / Fan</option>
          <option value="sonstige">Sonstige</option>
        </select>
      </div>

      <div class="status-line">
        Unter 16 Jahren ist eine Zustimmung eines Erziehungsberechtigten erforderlich.  
        Ein Konto ist bis zur Zustimmung ‚Äûgesperrt‚Äú.
      </div>

      <div class="row">
        <button id="btn-signup">Registrieren</button>
        <button id="btn-login">Login</button>
        <button id="btn-logout">Logout</button>
      </div>

      <div class="status-line">
        <span id="auth-user"></span>
      </div>
      <div id="auth-lock-info" class="status-line"></div>
      <div id="auth-msg" class="status-line"></div>
      <div id="auth-approval-link" class="status-line"></div>
    </section>

    <!-- 2b. Profil / Rolle -->
    <section id="sec-profile" class="section-card">
      <h2><span>2b. Profil / Rolle</span></h2>
      <div class="row">
        <label for="prof-role">Rolle</label>
        <select id="prof-role">
          <option value="">Bitte w√§hlen‚Ä¶</option>
          <option value="trainer">Trainer</option>
          <option value="spieler">Aktiver Spieler</option>
          <option value="scout">Scout</option>
          <option value="eltern">Elternteil</option>
          <option value="zuschauer">Zuschauer / Fan</option>
          <option value="sonstige">Sonstige</option>
        </select>
      </div>
      <div class="row">
        <label for="prof-club" id="prof-club-label">Verein (optional)</label>
        <input id="prof-club" type="text" size="30">
      </div>
      <div class="row">
        <label for="prof-extra" id="prof-extra-label">Zusatzinfo (optional)</label>
        <input id="prof-extra" type="text" size="40" placeholder="">
      </div>
      <div class="row">
        <button id="btn-save-profile" type="button">Profil speichern</button>
      </div>
      <div id="prof-msg" class="status-line"></div>
    </section>

    <!-- 2a. Spieler anlegen + Events -->
    <section id="sec-rating" class="section-card">
      <h2><span>2a. Spieler & Events</span></h2>
            <h3>2a. Spieler suchen</h3>
      <div class="row">
        <label for="pl-search-name">Spielername</label>
        <input id="pl-search-name" type="text" size="30" placeholder="z.B. Elias Koch">
        <button id="btn-player-search" type="button">Spieler suchen</button>
      </div>
      <div id="pl-search-results" class="status-line"></div>

      <h3>2a. Spieler anlegen (manuell)</h3>
      <div class="row">
        <label for="pl-first">Vorname</label>
        <input id="pl-first" type="text" size="20">
      </div>
      <div class="row">
        <label for="pl-last">Nachname</label>
        <input id="pl-last" type="text" size="20">
      </div>
      <div class="row">
        <label for="pl-birth">Geburtsdatum</label>
        <input id="pl-birth" type="date">
      </div>
      <div class="row">
        <label for="pl-club-current">Aktueller Verein</label>
        <input id="pl-club-current" type="text" size="30" placeholder="z.B. FC 08 Villingen U17">
      </div>
      <div class="row">
        <label for="pl-club-prev">Verein vorher</label>
        <input id="pl-club-prev" type="text" size="30" placeholder="z.B. SC Freiburg Jugend">
      </div>
      <div class="row">
        <label for="pl-pos">Position(en)</label>
        <select id="pl-pos" multiple size="6">
          <option value="TW">TW (Torwart)</option>
          <option value="AV">AV (Au√üenverteidiger)</option>
          <option value="IV">IV (Innenverteidiger)</option>
          <option value="MF">MF (Mittelfeld)</option>
          <option value="AST">AST (Au√üenst√ºrmer)</option>
          <option value="MST">MST (Mittelst√ºrmer)</option>
        </select>
        <span style="font-size:0.8rem;">Strg/Cmd gedr√ºckt halten f√ºr Mehrfachauswahl.</span>
      </div>

      <div class="row">
        <label for="pl-foot">Starker Fu√ü</label>
        <select id="pl-foot">
          <option value="">Bitte w√§hlen‚Ä¶</option>
          <option value="left">links</option>
          <option value="right">rechts</option>
          <option value="both">beidf√º√üig</option>
        </select>
      </div>

      <div class="row">
        <label for="pl-number">R√ºckennummer</label>
        <input id="pl-number" type="number" min="1" max="99" style="width:80px;">
      </div>

      <div class="row">
        <button id="btn-create-player" type="button">Spieler speichern</button>
      </div>
      <div id="player-create-msg" class="status-line"></div>

      <!-- Punkt 3 ist jetzt in einem eigenen Reiter / Section -->

      <h3>3b. Ereignis suchen</h3>
      <div class="row">
        <label for="search-pairing">Paarung / Spiel</label>
        <input id="search-pairing" type="text" size="40"
          placeholder="z.B. FC 08 Villingen - SC Freiburg U17" />
        <button id="btn-search-event" type="button">Suchen</button>
      </div>
      <div id="event-results"></div>

      <p id="event-current" style="font-size:0.9rem; color:#555; margin-top:10px;">
        Kein Spiel ausgew√§hlt.
      </p>

      <h3>3d. Event-Details</h3>
      <div id="event-card" style="
        background:#fff;
        border-radius:8px;
        padding:10px 14px;
        box-shadow:0 1px 3px rgba(0,0,0,0.12);
        max-width:600px;
        font-size:0.9rem;
      ">
        <p style="margin:0; color:#555;">Kein Spiel ausgew√§hlt.</p>
      </div>

      <div id="event-create-msg" class="status-line"></div>
    </section>

    <!-- 3. Bewertung erfassen ‚Äì eigener Reiter -->
    <section id="sec-rating-form" class="section-card">
      <h2><span>3. Bewertung erfassen</span></h2>

      <div class="row">
        <label for="r-player">Spieler</label>
        <select id="r-player"></select>
      </div>

      <div class="row">
        <label for="r-event">Event</label>
        <select id="r-event"></select>
      </div>

      <h3>Kriterien (Schulnoten 1‚Äì6)</h3>
      <div id="criteria"></div>

      <h3>Kommentar</h3>
      <textarea id="r-comment" placeholder="Kurze Beschreibung der Leistung..."></textarea>

      <div class="row" style="margin-top:10px;">
        <button id="btn-add-rating">Bewertung speichern</button>
      </div>

      <div id="rate-msg" class="status-line"></div>
    </section>

    <!-- 7. SpielerRadar -->
    <section id="sec-radar" class="section-card">
      <h2><span>7. SpielerRadar‚Ñ¢ (Live-Aktionen)</span></h2>
      <p style="font-size:0.85rem; color:#555;">
        W√§hle ein Event und einen Spieler. Danach kannst du mit gro√üen + / ‚àí Buttons
        Live-Aktionen erfassen (Ballsicherheit, Zweikampf, Laufduell, Abschluss, Standards, Mentalit√§t, Fair Play).
      </p>

      <!-- Watchlist-Tabs -->
      <div id="radar-watchlist"
           style="margin-bottom:12px; display:flex; gap:8px; flex-wrap:wrap;">
        <!-- Tabs werden per JS eingef√ºgt -->
      </div>

      <div class="row">
        <label for="radar-event-select">Event / Spiel</label>
        <select id="radar-event-select">
          <option value="">Bitte w√§hlen ‚Ä¶</option>
        </select>
      </div>

      <div class="row">
        <label for="radar-player-select">Spieler</label>
        <select id="radar-player-select">
          <option value="">Bitte w√§hlen ‚Ä¶</option>
        </select>
      </div>
      
      <div class="row">
        <button id="radar-add-to-watchlist" type="button">Zur Watchlist hinzuf√ºgen</button>
        <button id="radar-start-btn" type="button">Radar starten</button>
      </div>

      <div id="radar-status" class="status-line"></div>

      <!-- BLOCK: Radar-Ranking-Tabelle -->
      <div id="radar-summary" style="margin-top:16px;">
        <h3>Radar-Ranking (dieses Spiel)</h3>
        <table id="radar-summary-table">
          <thead>
            <tr>
              <th>Spieler</th>
              <th>Gesamt</th>
              <th>Ballsich.</th>
              <th>Zweikampf</th>
              <th>Laufduell</th>
              <th>Abschluss</th>
              <th>Standards</th>
              <th>Mentalit√§t</th>
              <th>Fair Play</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="9">Noch keine Radar-Daten.</td></tr>
          </tbody>
        </table>
        <div id="radar-summary-msg" class="status-line small-note"></div>
      </div>

      <!-- BLOCK: Radar-Live-Aktionen-Panel -->
      <div id="radar-panel" class="radar-panel">
        <h3 id="radar-player-label" class="radar-player-label">Live-Aktionen</h3>
        <p class="small-note">
          W√§hrend des Spiels einfach + (gute Aktionen) oder ‚àí (nicht so gute) tippen.
        </p>

        <!-- Ballsicherheit -->
        <div class="radar-action-row" data-field="ballsicherheit">
          <div class="radar-cat">
            <span class="radar-cat-icon">üßç‚Äç‚ôÇÔ∏è‚öΩ</span>
            <span class="radar-cat-label">Ballsicherheit</span>
          </div>

          <div class="radar-buttons">
            <button type="button"
              class="radar-btn radar-btn-plus"
              data-field="ballsicherheit">
              ballsicher
            </button>
            <button type="button"
              class="radar-btn radar-btn-minus"
              data-field="ballsicherheit">
              Ballverlust
            </button>
          </div>

          <div class="radar-netto">
            <span class="radar-score" data-field="ballsicherheit">
              Netto: 0 ( +0 / ‚àí0 )
            </span>
          </div>
        </div>

        <!-- Zweikampf -->
        <div class="radar-action-row" data-field="zweikampf">
          <div class="radar-cat">
            <span class="radar-cat-icon">ü§º‚Äç‚ôÇÔ∏è</span>
            <span class="radar-cat-label">Zweikampf</span>
          </div>

          <div class="radar-buttons">
            <button type="button"
              class="radar-btn radar-btn-plus"
              data-field="zweikampf">
              gewonnen
            </button>
            <button type="button"
              class="radar-btn radar-btn-minus"
              data-field="zweikampf">
              verloren
            </button>
          </div>

          <div class="radar-netto">
            <span class="radar-score" data-field="zweikampf">
              Netto: 0 ( +0 / ‚àí0 )
            </span>
          </div>
        </div>

        <!-- Laufduell -->
        <div class="radar-action-row" data-field="laufduell">
          <div class="radar-cat">
            <span class="radar-cat-icon">üèÉ‚Äç‚ôÇÔ∏è</span>
            <span class="radar-cat-label">Laufduell</span>
          </div>

          <div class="radar-buttons">
            <button type="button"
              class="radar-btn radar-btn-plus"
              data-field="laufduell">
              gewonnen
            </button>
            <button type="button"
              class="radar-btn radar-btn-minus"
              data-field="laufduell">
              verloren
            </button>
          </div>

          <div class="radar-netto">
            <span class="radar-score" data-field="laufduell">
              Netto: 0 ( +0 / ‚àí0 )
            </span>
          </div>
        </div>

        <!-- Abschluss -->
        <div class="radar-action-row" data-field="abschluss">
          <div class="radar-cat">
            <span class="radar-cat-icon">ü•Ö</span>
            <span class="radar-cat-label">Abschluss</span>
          </div>

          <div class="radar-buttons">
            <button type="button"
              class="radar-btn radar-btn-plus"
              data-field="abschluss">
              guter Abschluss
            </button>
            <button type="button"
              class="radar-btn radar-btn-minus"
              data-field="abschluss">
              schlechter Abschluss
            </button>
          </div>

          <div class="radar-netto">
            <span class="radar-score" data-field="abschluss">
              Netto: 0 ( +0 / ‚àí0 )
            </span>
          </div>
        </div>

        <!-- Standards -->
        <div class="radar-action-row" data-field="standard">
          <div class="radar-cat">
            <span class="radar-cat-icon">üìê</span>
            <span class="radar-cat-label">Standards</span>
          </div>

          <div class="radar-buttons">
            <button type="button"
              class="radar-btn radar-btn-plus"
              data-field="standard">
              gut ausgef√ºhrt
            </button>
            <button type="button"
              class="radar-btn radar-btn-minus"
              data-field="standard">
              schwach
            </button>
          </div>

          <div class="radar-netto">
            <span class="radar-score" data-field="standard">
              Netto: 0 ( +0 / ‚àí0 )
            </span>
          </div>
        </div>

        <!-- Mentalit√§t -->
        <div class="radar-action-row" data-field="mentalitaet">
          <div class="radar-cat">
            <span class="radar-cat-icon">üî•</span>
            <span class="radar-cat-label">Mentalit√§t</span>
          </div>

          <div class="radar-buttons">
            <button type="button"
              class="radar-btn radar-btn-plus"
              data-field="mentalitaet">
              gezeigt
            </button>
            <button type="button"
              class="radar-btn radar-btn-minus"
              data-field="mentalitaet">
              gefehlt
            </button>
          </div>

          <div class="radar-netto">
            <span class="radar-score" data-field="mentalitaet">
              Netto: 0 ( +0 / ‚àí0 )
            </span>
          </div>
        </div>

        <!-- Fair Play -->
        <div class="radar-action-row" data-field="fairplay">
          <div class="radar-cat">
            <span class="radar-cat-icon">ü§ù</span>
            <span class="radar-cat-label">Fair Play</span>
          </div>

          <div class="radar-buttons">
            <button type="button"
              class="radar-btn radar-btn-plus"
              data-field="fairplay">
              fair
            </button>
            <button type="button"
              class="radar-btn radar-btn-minus"
              data-field="fairplay">
              unsportlich
            </button>
          </div>

          <div class="radar-netto">
            <span class="radar-score" data-field="fairplay">
              Netto: 0 ( +0 / ‚àí0 )
            </span>
          </div>
        </div>
      </div>
    </section> <!-- Ende sec-radar -->

    <!-- 4. Ranking -->
    <section id="sec-ranking" class="section-card">
      <h2><span>4. Ranking</span></h2>

      <div class="row">
        <label for="club-filter">Verein</label>
        <select id="club-filter"></select>
      </div>

      <div class="row">
        <label for="rank-pos">Position</label>
        <select id="rank-pos">
          <option value="">Alle</option>
          <option value="TW">TW</option>
          <option value="AV">AV</option>
          <option value="IV">IV</option>
          <option value="MF">MF</option>
          <option value="AST">AST</option>
          <option value="MST">MST</option>
        </select>

        <label for="rank-foot">Starker Fu√ü</label>
        <select id="rank-foot">
          <option value="">Alle</option>
          <option value="left">links</option>
          <option value="right">rechts</option>
          <option value="both">beidf√º√üig</option>
        </select>
      </div>

      <div class="row">
        <label for="rank-type">Event-Typ</label>
        <select id="rank-type">
          <option value="">Alle</option>
          <option value="match">Spiel</option>
          <option value="training">Training</option>
          <option value="tournament">Turnier</option>
        </select>
      </div>
     
      <div class="row">
        <label for="rank-source">Quelle</label>
        <select id="rank-source">
          <option value="rating">Bewertungen (Noten)</option>
          <option value="radar">Radar (Live-Aktionen)</option>
        </select>
      </div>

      <div class="row">
        <label for="rank-role">Bewertungs-Rolle</label>
        <select id="rank-role">
          <option value="">Alle</option>
          <option value="trainer">Trainer</option>
          <option value="scout">Scout</option>
          <option value="eltern">Eltern</option>
          <option value="spieler">Mitspieler</option>
          <option value="sonstige">Sonstige</option>
        </select>
      </div>

      <div class="row">
        <label for="rank-from">Von Datum</label>
        <input id="rank-from" type="date">
        <label for="rank-to">Bis Datum</label>
        <input id="rank-to" type="date">
      </div>

      <div class="row">
        <label for="rank-min">Min. Bewertungen</label>
        <input id="rank-min" type="number" value="1" min="0" style="width:70px;">
      </div>

      <div class="row">
        <label for="rank-q">Suche (Name/Verein)</label>
        <input id="rank-q" type="text" size="30">
      </div>

      <div class="row">
        <label for="fav-filter">Watchlist</label>
        <select id="fav-filter">
          <option value="">Alle</option>
          <option value="fav">Nur Favoriten</option>
        </select>
        <label>
          <input type="checkbox" id="rank-top10">
          nur Top 10
        </label>
        <button id="btn-refresh-ranking" type="button">Ranking aktualisieren</button>
        <button id="btn-export-csv" type="button">CSV-Export</button>
      </div>

      <div id="rank-msg" class="status-line"></div>

      <table id="rank-table">
        <thead>
          <tr>
            <th>‚òÖ</th>
            <th>Spieler</th>
            <th>Verein</th>
            <th>Pos</th>
            <th>Fu√ü</th>
            <th>#Bewertungen</th>
            <th>√ò Note</th>
            <th>Letztes Event</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="8">Noch keine Daten.</td></tr>
        </tbody>
      </table>
    </section>

    <!-- 5. Kalender-Import (ICS) -->
    <section id="sec-events" class="section-card">
      <h2><span>5. Kalender-Import (ICS)</span></h2>
      <div class="row">
        <label for="ics-file">ICS-Datei</label>
        <input id="ics-file" type="file" accept=".ics">
        <button id="btn-import-ics">Datei importieren</button>
      </div>
      <div class="row">
        <label for="ics-url">ICS-URL</label>
        <input id="ics-url" type="text" size="60" placeholder="https://.../kalender.ics">
        <button id="btn-import-ics-url">Von URL laden</button>
      </div>
      <div id="ics-msg" class="status-line"></div>
    </section>

    <!-- 6. Letzte Bewertungen -->
    <section id="sec-last" class="section-card">
      <h2><span>6. Letzte Bewertungen</span></h2>
      <table>
        <thead>
          <tr>
            <th>Datum</th>
            <th>Spieler</th>
            <th>Event</th>
            <th>Kommentar</th>
          </tr>
        </thead>
        <tbody id="last-ratings">
          <tr><td colspan="4">Noch keine Bewertungen.</td></tr>
        </tbody>
      </table>
    </section>
  </main>

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .catch(err => console.error('SW registration failed:', err));
    }
  </script>

   <!-- Navigation -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const buttons = Array.from(document.querySelectorAll('.top-nav button'));
      const sections = {
        'sec-config':       document.getElementById('sec-config'),
        'sec-auth':         document.getElementById('sec-auth'),
        'sec-profile':      document.getElementById('sec-profile'),
        'sec-rating':       document.getElementById('sec-rating'),
        'sec-rating-form':  document.getElementById('sec-rating-form'), // NEU
        'sec-radar':        document.getElementById('sec-radar'),
        'sec-ranking':      document.getElementById('sec-ranking'),
        'sec-events':       document.getElementById('sec-events'),
        'sec-last':         document.getElementById('sec-last')
      };

      function showSection(id) {
        Object.entries(sections).forEach(([key, el]) => {
          if (!el) return;
          el.style.display = (key === id) ? 'block' : 'none';
        });
        buttons.forEach(btn => {
          btn.classList.toggle('active', btn.dataset.target === id);
        });
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      window.npShowSection = showSection;

          buttons.forEach(btn => {
      btn.addEventListener('click', () => {
        const target = btn.dataset.target;
        if (target && sections[target]) {
          showSection(target);

          // Spezialf√§lle: beim √ñffnen Daten laden
          if (target === 'sec-ranking' && typeof refreshRanking === 'function') {
            refreshRanking();
          }
          if (target === 'sec-last' && typeof refreshLastComments === 'function') {
            refreshLastComments();
          }
        }
      });
    });

      // Start mit Setup
      showSection('sec-config');
    });
  </script>
  <!-- Supabase-Logik -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.48.0/+esm';

    // Kurz-Helper
    const $  = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));

    function isUUID(v) {
      return typeof v === 'string' &&
        /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(v);
    }

    let supa = null;
    let currentUser = null;
    let currentUserMeta = null;
    let currentProfile = null;
    let currentEvent = null;
    let allEvents = [];

    // -----------------------------
    // Supabase-Konfiguration
    // -----------------------------
    function loadConfig() {
      return {
        url: localStorage.getItem('sb_url') || '',
        key: localStorage.getItem('sb_key') || ''
      };
    }

    function saveConfig(url, key) {
      localStorage.setItem('sb_url', url || '');
      localStorage.setItem('sb_key', key || '');
    }

    function resetClient() {
      supa = null;
    }

    function ensureClient() {
      const { url, key } = loadConfig();
      if (!url || !key) {
        const msg = $('#conf-msg');
        if (msg) msg.textContent = 'Bitte Supabase-URL und Anon-Key speichern.';
        throw new Error('Supabase-Konfiguration fehlt');
      }
      supa = createClient(url, key, {
        auth: { storageKey: 'scout-app-auth', multiTab: false }
      });
      return supa;
    }

    async function getClient() {
      if (supa) return supa;
      return ensureClient();
    }

    $('#btn-save-conf')?.addEventListener('click', () => {
      const url = ($('#sb-url')?.value || '').trim();
      const key = ($('#sb-key')?.value || '').trim();
      const msg = $('#conf-msg');
      if (!url || !key) {
        if (msg) msg.textContent = 'Bitte URL und Anon-Key eingeben.';
        return;
      }
      saveConfig(url, key);
      resetClient();
      if (msg) msg.textContent = 'Konfiguration gespeichert.';
    });

    $('#btn-test-conf')?.addEventListener('click', async () => {
      const msg = $('#conf-msg');
      if (msg) msg.textContent = 'Teste Verbindung‚Ä¶';

      const url = ($('#sb-url')?.value || '').trim();
      const key = ($('#sb-key')?.value || '').trim();
      if (url && key) {
        saveConfig(url, key);
        resetClient();
      }

      try {
        const c = await getClient();
        const { error } = await c.auth.getSession();
        if (error) {
          if (msg) msg.textContent = 'Fehler: ' + error.message;
        } else {
          if (msg) msg.textContent = 'OK: Verbindung funktioniert.';
        }
      } catch (e) {
        console.error(e);
        if (msg) msg.textContent = 'Verbindung fehlgeschlagen: ' + (e.message || e);
        resetClient();
      }
    });

    // -----------------------------
    // Auth & Jugendschutz
    // -----------------------------
    function updateAuthLockInfo() {
      const el = $('#auth-lock-info');
      const approvalBox = $('#auth-approval-link');
      if (!el) return;

      if (!currentUser) {
        el.innerHTML = '';
        if (approvalBox) approvalBox.innerHTML = '';
        return;
      }
      if (!currentUserMeta) {
        el.innerHTML = '‚ÑπÔ∏è Kein Altersprofil hinterlegt. Konto gilt als freigeschaltet (Testmodus).';
        return;
      }

      const year = currentUserMeta.birth_year;
      if (!year) {
        el.innerHTML = '‚ÑπÔ∏è Geburtsjahr fehlt im Profil.';
        return;
      }
      const nowYear = new Date().getFullYear();
      const age = nowYear - year;
      const minor = age < 16;

      if (minor && currentUserMeta.parent_required) {
        if (currentUserMeta.parent_approved) {
          el.innerHTML = `‚úÖ Konto freigeschaltet (minderj√§hrig, ca. ${age} Jahre, Elternzustimmung liegt vor).`;
        } else {
          el.innerHTML =
            `üîí Konto gesperrt (minderj√§hrig, ca. ${age} Jahre). ` +
            `Bitte Freigabelink an einen Erziehungsberechtigten senden.`;
        }
      } else if (minor) {
        el.innerHTML =
          `‚ÑπÔ∏è Minderj√§hrig (ca. ${age} Jahre) ‚Äì Elternzustimmung ist derzeit nicht als Pflicht markiert.`;
      } else {
        el.innerHTML =
          `‚úÖ Konto freigeschaltet (ca. ${age} Jahre, keine Elternzustimmung erforderlich).`;
      }
    }

    function isMinorLocked() {
      if (!currentUserMeta) return false;
      if (!currentUserMeta.parent_required) return false;
      const year = currentUserMeta.birth_year;
      if (!year) return false;
      const nowYear = new Date().getFullYear();
      const age = nowYear - year;
      return age < 16 && !currentUserMeta.parent_approved;
    }

    async function loadCurrentUser() {
      try {
        const c = await getClient();
        const { data } = await c.auth.getSession();
        currentUser = data?.session?.user || null;
        const elUser = $('#auth-user');
        if (elUser) {
          elUser.textContent = currentUser ? `Angemeldet: ${currentUser.email}` : '';
        }
      } catch (e) {
        console.error('loadCurrentUser', e);
        currentUser = null;
      }
    }

    async function loadUserMeta() {
      if (!currentUser) {
        currentUserMeta = null;
        updateAuthLockInfo();
        return;
      }
      try {
        const c = await getClient();
        const { data, error } = await c
          .from('user_profile')
          .select('id, nickname, birth_year, parent_email, parent_required, parent_approved')
          .eq('id', currentUser.id)
          .maybeSingle();

        if (!error && data) {
          currentUserMeta = data;
        } else {
          currentUserMeta = null;
        }
      } catch (e) {
        console.error('loadUserMeta', e);
        currentUserMeta = null;
      }
      updateAuthLockInfo();
    }

    function generateToken() {
      const arr = new Uint8Array(16);
      crypto.getRandomValues(arr);
      return Array.from(arr).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    async function ensureApprovalLinkForCurrentUser() {
      const approvalBox = $('#auth-approval-link');
      if (!currentUser || !currentUserMeta || !approvalBox) return;

      const childId = currentUserMeta.id || currentUser.id;

      let email =
        currentUserMeta.parent_email ||
        ($('#reg-parent-email')?.value || '').trim() ||
        currentUser.email ||
        '';

      if (!email) {
        console.warn('ensureApprovalLinkForCurrentUser: keine Eltern-Mail gefunden.');
        return;
      }

      try {
        const c = await getClient();

        const { data, error } = await c
          .from('parental_consent')
          .select('token, email')
          .eq('child_id', childId)
          .maybeSingle();

        let token;
        if (!error && data && data.token) {
          token = data.token;
          email = data.email || email;
        } else {
          token = generateToken();
          const { error: insErr } = await c
            .from('parental_consent')
            .insert({
              child_id: childId,
              token,
              email
            });
          if (insErr) {
            console.error('ensureApprovalLinkForCurrentUser insert error', insErr);
            return;
          }
        }

        const base = window.location.origin + window.location.pathname.replace(/index\.html$/, '');
        const link = `${base}approve.html?token=${token}`;

        const subject = encodeURIComponent('Einwilligung f√ºr NextPlayer‚Ñ¢');
        const body = encodeURIComponent(
          `Hallo,\n\n` +
          `bitte klicken Sie auf folgenden Link, um die Nutzung der App NextPlayer‚Ñ¢ f√ºr Ihr Kind zu erlauben:\n\n` +
          `${link}\n\n` +
          `Viele Gr√º√üe\nNextPlayer‚Ñ¢`
        );

        approvalBox.innerHTML =
          `Freigabelink: <a href="${link}" target="_blank">${link}</a><br>` +
          `<a href="mailto:${encodeURIComponent(email)}?subject=${subject}&body=${body}">` +
          `E-Mail mit diesem Link √∂ffnen</a>`;
      } catch (e) {
        console.error('ensureApprovalLinkForCurrentUser', e);
      }
    }

    // Registrierung
    $('#btn-signup')?.addEventListener('click', async () => {
      const email       = ($('#auth-email')?.value || '').trim();
      const pwd         = ($('#auth-pass')?.value || '').trim();
      const nick        = ($('#reg-nick')?.value || '').trim();
      const yearStr     = ($('#reg-year')?.value || '').trim();
      const regRole     = ($('#reg-role')?.value || '').trim();
      const parentEmail = ($('#reg-parent-email')?.value || '').trim();
      const msg         = $('#auth-msg');
      const approvalBox = $('#auth-approval-link');

      if (msg) msg.textContent = '';
      if (approvalBox) approvalBox.innerHTML = '';

      if (!email || !pwd) {
        if (msg) msg.textContent = 'Bitte E-Mail & Passwort eingeben.';
        return;
      }
      if (!nick || !yearStr) {
        if (msg) msg.textContent = 'Bitte K√ºnstlername und Geburtsjahr ausf√ºllen.';
        return;
      }
      if (!regRole) {
        if (msg) msg.textContent = 'Bitte eine Rolle f√ºr das Konto ausw√§hlen.';
        return;
      }

      const birthYear = parseInt(yearStr, 10);
      const nowYear   = new Date().getFullYear();
      if (isNaN(birthYear) || birthYear < 2000 || birthYear > nowYear) {
        if (msg) msg.textContent = 'Geburtsjahr ist nicht plausibel.';
        return;
      }
      const age            = nowYear - birthYear;
      const parentRequired = age < 16;

      if (parentRequired && !parentEmail) {
        if (msg) msg.textContent = 'F√ºr U16 ist eine Eltern-E-Mail erforderlich.';
        return;
      }

      try {
        const c = await getClient();
        const { data, error } = await c.auth.signUp({ email, password: pwd });
        if (error) {
          if (msg) msg.textContent = 'Fehler: ' + error.message;
          return;
        }

        const user = data?.user;
        if (!user) {
          if (msg) msg.textContent = 'Registrierung gestartet ‚Äì bitte E-Mail best√§tigen.';
          return;
        }

        const { error: profErr } = await c
          .from('user_profile')
          .insert({
            id: user.id,
            nickname: nick,
            birth_year: birthYear,
            parent_email: parentEmail || null,
            parent_required: parentRequired,
            parent_approved: parentRequired ? false : true
          });

        if (profErr) {
          console.error('user_profile insert', profErr);
          if (msg) msg.textContent = 'Konto erstellt, aber Profil (Alter) konnte nicht gespeichert werden.';
          return;
        }

        const { error: prof2Err } = await c
          .from('profile')
          .upsert({
            user_id: user.id,
            role: regRole,
            club_name: null,
            extra_info: null
          }, { onConflict: 'user_id' });

        if (prof2Err) {
          console.error('profile insert error', prof2Err);
          if (msg) msg.textContent = 'Konto angelegt, aber Profil-Rolle konnte nicht gespeichert werden.';
          return;
        }

        if (parentRequired) {
          const token = generateToken();
          const contactEmail = parentEmail || email;

          const { error: consentErr } = await c
            .from('parental_consent')
            .insert({
              child_id: user.id,
              token,
              email: contactEmail
            });

          if (consentErr) {
            console.error('parental_consent insert error', consentErr);
            if (msg) msg.textContent =
              'Registrierung erfolgreich. Konto ist gesperrt, aber Freigabelink konnte nicht gespeichert werden.';
            return;
          }

          const base = window.location.origin + window.location.pathname.replace(/index\.html$/, '');
          const link = `${base}approve.html?token=${token}`;

          const subject = encodeURIComponent('Einwilligung f√ºr NextPlayer‚Ñ¢');
          const body = encodeURIComponent(
            `Hallo,\n\n` +
            `bitte klicken Sie auf folgenden Link, um die Nutzung der App NextPlayer‚Ñ¢ f√ºr Ihr Kind zu erlauben:\n\n` +
            `${link}\n\n` +
            `Viele Gr√º√üe\nNextPlayer‚Ñ¢`
          );

          if (approvalBox) {
            approvalBox.innerHTML =
              `Freigabelink: <a href="${link}" target="_blank">${link}</a><br>` +
              `<a href="mailto:${encodeURIComponent(contactEmail)}?subject=${subject}&body=${body}">` +
              `E-Mail mit diesem Link √∂ffnen</a>`;
          }

          if (msg) msg.textContent =
            'Registrierung erfolgreich. Konto ist gesperrt, bis ein Erziehungsberechtigter zugestimmt hat.';
        } else {
          if (msg) msg.textContent = 'Registrierung erfolgreich. Du kannst dich jetzt einloggen.';
        }

      } catch (e) {
        console.error(e);
        const msg2 = $('#auth-msg');
        if (msg2) msg2.textContent = 'Fehler bei Registrierung.';
      }
    });

    // Login
    $('#btn-login')?.addEventListener('click', async () => {
      const email = ($('#auth-email')?.value || '').trim();
      const pwd   = ($('#auth-pass')?.value || '').trim();
      const msg   = $('#auth-msg');
      const approvalBox = $('#auth-approval-link');

      if (approvalBox) approvalBox.innerHTML = '';

      if (!email || !pwd) {
        if (msg) msg.textContent = 'Bitte E-Mail & Passwort eingeben.';
        return;
      }

      try {
        const c = await getClient();
        const { data, error } = await c.auth.signInWithPassword({ email, password: pwd });

        if (error) {
          if (msg) msg.textContent = 'Login fehlgeschlagen: ' + error.message;
          return;
        }

        currentUser = data?.user || null;
        const elUser = $('#auth-user');
        if (elUser) elUser.textContent = `Angemeldet: ${currentUser?.email || email}`;

        await loadUserMeta();
        await loadProfile();
        await refreshAllData();

        const locked = isMinorLocked();

        if (locked) {
          if (msg) msg.textContent =
            'Login OK, aber dein Konto ist noch gesperrt (Elternzustimmung fehlt).';

          await ensureApprovalLinkForCurrentUser();

          if (window.npShowSection) {
            window.npShowSection('sec-auth');
          }
          return;
        }

        if (msg) msg.textContent = 'Login OK.';
        if (window.npShowSection) {
          window.npShowSection('sec-rating');
        }

      } catch (e) {
        console.error(e);
        const msg2 = $('#auth-msg');
        if (msg2) msg2.textContent = 'Fehler beim Login.';
      }
    });

    // Logout
    $('#btn-logout')?.addEventListener('click', async () => {
      try {
        const c = await getClient();
        await c.auth.signOut();
      } catch (e) {
        console.error('logout error', e);
      }

      currentUser = null;
      currentUserMeta = null;
      currentProfile = null;
      currentEvent = null;

      const msg         = $('#auth-msg');
      const approvalBox = $('#auth-approval-link');
      const elUser      = $('#auth-user');
      const lockInfo    = $('#auth-lock-info');

      if (msg)        msg.textContent = 'Abgemeldet.';
      if (elUser)     elUser.textContent = '';
      if (approvalBox) approvalBox.innerHTML = '';
      if (lockInfo)  lockInfo.textContent = '';

      const idsToClear = [
        'auth-email',
        'auth-pass',
        'reg-nick',
        'reg-year',
        'reg-parent-email'
      ];
      idsToClear.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
      });
      const regRoleSel = document.getElementById('reg-role');
      if (regRoleSel) regRoleSel.value = '';

      const profRoleSel = document.getElementById('prof-role');
      const profClub    = document.getElementById('prof-club');
      const profExtra   = document.getElementById('prof-extra');

      if (profRoleSel) {
        profRoleSel.value = '';
        profRoleSel.disabled = false;
      }
      if (profClub)  profClub.value  = '';
      if (profExtra) profExtra.value = '';

      updateAuthLockInfo();

      if (window.npShowSection) {
        window.npShowSection('sec-auth');
      }
    });

    // -----------------------------
    // Profil / Rolle (2b)
    // -----------------------------
    function updateProfileFormForRole() {
      const roleSel   = document.getElementById('prof-role');
      const clubLabel = document.getElementById('prof-club-label');
      const extraLabel= document.getElementById('prof-extra-label');

      if (!roleSel || !clubLabel || !extraLabel) return;

      const role = roleSel.value;

      clubLabel.textContent  = 'Verein (optional)';
      extraLabel.textContent = 'Zusatzinfo (optional)';

      if (role === 'spieler') {
        clubLabel.textContent  = 'Aktueller Verein (Pflicht)';
        extraLabel.textContent = 'Zusatzinfo Spieler (z.B. Position, Liga, optional)';
      } else if (role === 'trainer') {
        clubLabel.textContent  = 'Verein als Trainer (Pflicht)';
        extraLabel.textContent = 'Lizenzangabe (optional, z.B. ‚ÄûUEFA B‚Äú)';
      } else if (role === 'scout') {
        clubLabel.textContent  = 'Verein / Organisation als Scout (optional)';
        extraLabel.textContent = 'Weitere Infos (optional)';
      } else if (role === 'eltern') {
        clubLabel.textContent  = 'Verein des Kindes (optional)';
        extraLabel.textContent = 'Weitere Infos (optional)';
      } else if (role === 'zuschauer') {
        clubLabel.textContent  = 'Lieblingsverein (optional)';
        extraLabel.textContent = 'Weitere Infos (optional)';
      }
    }

    document.getElementById('prof-role')?.addEventListener('change', updateProfileFormForRole);

    async function saveProfile() {
      const msg       = document.getElementById('prof-msg');
      const roleSel   = document.getElementById('prof-role');
      const clubInput = document.getElementById('prof-club');
      const extraInput= document.getElementById('prof-extra');

      if (!currentUser) {
        if (msg) msg.textContent = 'Bitte zuerst einloggen.';
        return;
      }
      if (isMinorLocked()) {
        if (msg) msg.textContent = 'Dein Konto ist noch nicht freigeschaltet (Elternzustimmung fehlt).';
        return;
      }

      let role = roleSel?.value || '';
      if (!role && currentProfile && currentProfile.role) {
        role = currentProfile.role;
      }
      if (!role) {
        if (msg) msg.textContent = 'Bitte eine Rolle ausw√§hlen.';
        return;
      }

      const club_name  = (clubInput?.value || '').trim();
      const extra_info = (extraInput?.value || '').trim();

      if ((role === 'spieler' || role === 'trainer') && !club_name) {
        if (msg) msg.textContent = 'Bitte den Verein angeben (Pflicht f√ºr Spieler & Trainer).';
        return;
      }

      try {
        const c = await getClient();
        const payload = {
          user_id: currentUser.id,
          role,
          club_name:  club_name  || null,
          extra_info: extra_info || null
        };

        const { data, error } = await c
          .from('profile')
          .upsert(payload, { onConflict: 'user_id' })
          .select('user_id, role, club_name, extra_info')
          .single();

        if (error) {
          console.error('saveProfile error', error);
          if (msg) msg.textContent = 'Fehler beim Speichern des Profils.';
          return;
        }

        currentProfile = data;
        if (msg) msg.textContent = 'Profil gespeichert.';

        updateProfileFormForRole();
        if (window.npShowSection) {
          window.npShowSection('sec-rating');
        }
      } catch (e) {
        console.error('saveProfile', e);
        if (msg) msg.textContent = 'Fehler beim Speichern.';
      }
    }

    document.getElementById('btn-save-profile')?.addEventListener('click', saveProfile);

    async function loadProfile() {
      if (!currentUser) {
        currentProfile = null;
        return;
      }
      try {
        const c = await getClient();
        const { data, error } = await c
          .from('profile')
          .select('user_id, role, club_name, extra_info')
          .eq('user_id', currentUser.id)
          .maybeSingle();

        if (!error && data) {
          currentProfile = data;

          const roleSel    = document.getElementById('prof-role');
          const clubInput  = document.getElementById('prof-club');
          const extraInput = document.getElementById('prof-extra');

          if (roleSel) {
            roleSel.value = data.role || '';
            if (data.role) {
              roleSel.disabled = true;
            }
          }
          if (clubInput)  clubInput.value  = data.club_name  || '';
          if (extraInput) extraInput.value = data.extra_info || '';

          updateProfileFormForRole();
        } else {
          currentProfile = null;
        }
      } catch (e) {
        console.error('loadProfile', e);
        currentProfile = null;
      }
    }

    // -----------------------------
    // Rating / Spieler / Events / Ranking / ICS / Verlauf
    // -----------------------------
    const ratingKeys = [
      ['technik','Technik'],
      ['taktik','Taktik'],
      ['intelligenz','Spielintelligenz'],
      ['handlung','Handlungsschnelligkeit'],
      ['mentalitaet','Mentalit√§t'],
      ['physis','Physis'],
      ['team','Teamverhalten'],
      ['konzentration','Konzentration'],
      ['kreativitaet','Kreativit√§t'],
      ['tempo','Spieltempo'],
      ['offensiv','Offensiv'],
      ['defensiv','Defensiv']
    ];
    const gradeSteps = ['1','1.5','2','2.5','3','3.5','4','4.5','5','5.5','6'];

    function gradeCells() {
      return gradeSteps.map(v => `<option value="${v}">${v}</option>`).join('');
    }

    function buildCriteriaUI() {
      const wrap = document.querySelector('#criteria');
      if (!wrap) return;
      wrap.innerHTML = '';
      ratingKeys.forEach(([key,label]) => {
        const div = document.createElement('div');
        div.style.minWidth = '150px';
        div.innerHTML = `
          <label>${label}</label>
          <select data-k="${key}">
            ${gradeCells()}
          </select>`;
        wrap.appendChild(div);
      });
    }
    buildCriteriaUI();

    // ... HIER: Due to Platz & Zeit breche ich bewusst ab ...

  </script>
</body>
</html>
