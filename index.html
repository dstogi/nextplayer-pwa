<!doctype html> 
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>NextPlayer‚Ñ¢ ‚Äì Scouting App</title>

  <!-- PWA & Mobil -->
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#050608" />
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" type="image/png" sizes="192x192" href="NextPlayer-192.png" />
  <link rel="apple-touch-icon" href="NextPlayer-512.png" />

  <style>
   #sec-ranking {
  border: 2px solid red !important;
}
    
    :root {
      --np-bg: #050608;
      --np-card: #ffffff;
      --np-accent: #f5b642;
      --np-text: #111111;
      --np-muted: #666666;
    }

    * { box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0;
      padding: 0;
      background: #f1f1f1;
      color: var(--np-text);
    }
   
    .radar-tab {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid #ccc;
      background: #eee;
      cursor: pointer;
      font-size: 0.85rem;
    }

    .radar-tab.active {
      background: var(--np-accent);
      border-color: var(--np-accent);
      color: #111;
      font-weight: 600;
    }

    .card {
      background: #ffffff;
      border-radius: 6px;
      padding: 16px;
      margin: 16px 0;
      box-shadow: 0 1px 3px rgba(0,0,0,0.12);
    }

    .card-section h3 {
      margin-top: 0;
    }
    
    /* Neues Panel-Layout f√ºr Live-Aktionen */
    .radar-panel {
      display: none;              /* wird per JS auf block gesetzt */
      margin-top: 10px;
      border-top: 1px solid #eee;
      padding: 12px 14px;
      border-radius: 10px;
      transition: background-color 0.2s ease;
    }

    .radar-player-label {
      font-weight: 600;
      margin-bottom: 8px;
    }
/* --- Radar: Klarere Struktur & Boxen --- */

/* Intro-Text im Radar etwas dezenter */
#sec-radar p {
  margin-top: 4px;
  margin-bottom: 10px;
  font-size: 0.85rem;
  color: var(--np-muted);
}

/* Die ersten Zeilen (Event & Spieler) als Filter-Box hervorheben */
#sec-radar .row:nth-of-type(1),
#sec-radar .row:nth-of-type(2) {
  background: #fafafa;
  border-radius: 6px;
  padding: 6px 8px;
}

/* Radar-Tabs mit etwas Luft nach oben/unten */
#sec-radar .radar-tab {
  margin-top: 4px;
}

/* Panel f√ºr Live-Aktionen als eigene ‚ÄûKarte‚Äú */
#sec-radar .radar-panel {
  margin-top: 10px;
  background: #ffffff;
  border-radius: 10px;
  border: 1px solid #e0e0e0;
  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
  padding: 10px 12px;
}

/* Label im Panel hervorheben (falls benutzt) */
#sec-radar .radar-player-label {
  font-weight: 600;
  margin-bottom: 6px;
}

    /* --- Radar Live-Aktionen: bessere Bedienbarkeit --- */

.radar-action-row {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 8px 16px;
  margin-bottom: 10px;
}

.radar-cat {
  display: flex;
  align-items: center;
  min-width: 150px;
  font-weight: 600;
}

.radar-cat-icon {
  font-size: 1.2rem;
  margin-right: 6px;
}

.radar-buttons {
  display: flex;
  gap: 8px;
}

.radar-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  border-radius: 999px;
  padding: 6px 12px;
  font-size: 0.9rem;
  border: 1px solid transparent;
  cursor: pointer;
  min-width: 90px;
}

/* gr√ºnes Plus */
.radar-btn-plus {
  background: #e6f7ea;
  color: #1b7a2f;
  border-color: #1b7a2f;
}
.radar-btn-plus::before {
  content: 'Ôºã';
  font-weight: 700;
  margin-right: 4px;
}

/* rotes Minus */
.radar-btn-minus {
  background: #fde7e7;
  color: #b32020;
  border-color: #b32020;
}
.radar-btn-minus::before {
  content: '‚àí';
  font-weight: 700;
  margin-right: 4px;
}

.radar-btn:active {
  transform: translateY(1px);
}

.radar-netto {
  font-size: 0.8rem;
  color: var(--np-muted);
}

    #pl-search-results button {
  border-radius: 6px;
  border: 1px solid #ddd;
  background: #fff;
}
#pl-search-results button:hover {
  background: #f7f7f7;
}
    
/* Kleine Hinweise im Radar etwas einheitlicher */
#sec-radar .small-note {
  font-size: 0.8rem;
  color: var(--np-muted);
}

    .small-note {
      font-size: 0.85rem;
      color: var(--np-muted);
    }

    #radar-panel.active {
      background: rgba(245, 182, 66, 0.10); /* leichter Goldschimmer */
      border-top-color: var(--np-accent);
    }

    header {
      background: linear-gradient(135deg, #000000, #151515);
      color: #fff;
      padding: 14px 18px 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.35);
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    header h1 {
      margin: 0;
      font-size: 1.3rem;
      letter-spacing: 0.03em;
    }

    header .subtitle {
      margin: 4px 0 0;
      font-size: 0.8rem;
      color: #c0c0c0;
    }

    .top-nav {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .top-nav button {
      border: 1px solid rgba(255,255,255,0.3);
      background: rgba(0,0,0,0.4);
      color: #f5f5f5;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 0.75rem;
      cursor: pointer;
      white-space: nowrap;
    }

    .top-nav button.active {
      background: var(--np-accent);
      border-color: var(--np-accent);
      color: #111;
      font-weight: 600;
    }

    main {
      padding: 16px;
      max-width: 1100px;
      margin: 0 auto 40px;
    }

    .section-card {
      background: var(--np-card);
      border-radius: 10px;
      padding: 14px 14px 16px;
      margin-bottom: 16px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
      border: 1px solid rgba(0,0,0,0.04);
    }

    .section-card h2 {
      margin-top: 0;
      padding-bottom: 4px;
      border-bottom: 2px solid rgba(0,0,0,0.06);
      font-size: 1rem;
    }

    .section-card h2 span {
      border-left: 4px solid var(--np-accent);
      padding-left: 6px;
    }

    h3 {
      margin-top: 14px;
      margin-bottom: 6px;
      font-size: 0.95rem;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
    }

    label {
      display: inline-block;
      min-width: 140px;
      font-size: 0.9rem;
    }

    input, select, textarea, button {
      padding: 4px 6px;
      font-size: 0.9rem;
    }

    input, select, textarea {
      border-radius: 4px;
      border: 1px solid #ccc;
    }

    button {
      border-radius: 4px;
      border: 1px solid #ccc;
      cursor: pointer;
      background: #f3f3f3;
    }

    button.primary {
      background: var(--np-accent);
      border-color: var(--np-accent);
      color: #111;
      font-weight: 600;
    }

    textarea {
      width: 100%;
      max-width: 600px;
      min-height: 60px;
    }

    .status-line {
      margin-top: 5px;
      font-size: 0.8rem;
      color: var(--np-muted);
    }

    #criteria > div {
      margin-bottom: 6px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      max-width: 900px;
      background: #fff;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 4px 6px;
      font-size: 0.8rem;
      text-align: left;
    }

    th {
      background: #f5f5f5;
    }

    .fav-toggle {
      cursor: pointer;
      font-size: 1rem;
    }
  
    .jersey-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #111;
      color: #fff;
      font-size: 0.75rem;
      font-weight: 600;
    }

    @media (max-width: 700px) {
      main { padding: 10px; }
      label { min-width: 110px; }
      .row { gap: 6px; }
      header h1 { font-size: 1.1rem; }
    }
  </style>
</head>
<body>
  <header>
    <h1>NextPlayer‚Ñ¢ ‚Äì Scouting App</h1>
    <div class="subtitle">Bewertungen sammeln, Ranking sehen, Talente entdecken.</div>

    <div class="top-nav">
  <button data-target="sec-config"  class="active">üõ†Ô∏è Setup</button>
  <button data-target="sec-auth">üîë Login</button>
  <button data-target="sec-profile">üë§ Profil</button>
  <button data-target="sec-rating">‚öΩ Spieler & Events</button>
  <button data-target="sec-rating-form">‚≠ê Bewertung</button>
  <button data-target="sec-radar">üì° Radar</button>
  <button data-target="sec-ranking">üìä Ranking</button>
  <button data-target="sec-events">üìÖ Events</button>
  <button data-target="sec-last">üïí Verlauf</button>
</div>
  </header>

  <main>

    <!-- 1. Supabase-Konfiguration -->
    <section id="sec-config" class="section-card">
      <h2><span>1. Supabase-Konfiguration</span></h2>
      <div class="row">
        <label for="sb-url">Supabase URL</label>
        <input id="sb-url" type="text" size="40" placeholder="https://xxxx.supabase.co">
      </div>
      <div class="row">
        <label for="sb-key">Anon Key</label>
        <input id="sb-key" type="text" size="60" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...">
      </div>
      <div class="row">
        <button id="btn-save-conf">Speichern</button>
        <button id="btn-test-conf">Verbindung testen</button>
      </div>
      <div id="conf-msg" class="status-line"></div>
    </section>

    <!-- 2. Login / Registrierung -->
    <section id="sec-auth" class="section-card">
      <h2><span>2. Login / Registrierung</span></h2>

      <h3>Login & Grunddaten</h3>
      <div class="row">
        <label for="auth-email">E-Mail</label>
        <input id="auth-email" type="email" size="30">
      </div>
      <div class="row">
        <label for="auth-pass">Passwort</label>
        <input id="auth-pass" type="password" size="20">
      </div>

      <h3>Nur f√ºr Registrierung (Konto anlegen)</h3>
      <div class="row">
        <label for="reg-nick">K√ºnstlername</label>
        <input id="reg-nick" type="text" size="20" placeholder="z.B. NextLeo10">
      </div>
      <div class="row">
        <label for="reg-year">Geburtsjahr</label>
        <input id="reg-year" type="number" min="2000" max="2100" size="6" placeholder="z.B. 2010">
      </div>
      <div class="row">
        <label for="reg-parent-email">Eltern-E-Mail</label>
        <input id="reg-parent-email" type="email" size="30" placeholder="Pflicht bei U16, optional sonst">
      </div>
      <div class="row">
        <label for="reg-role">Rolle</label>
        <select id="reg-role">
          <option value="">Bitte w√§hlen‚Ä¶</option>
          <option value="spieler">Aktiver Spieler</option>
          <option value="trainer">Trainer</option>
          <option value="scout">Scout</option>
          <option value="eltern">Elternteil</option>
          <option value="zuschauer">Zuschauer / Fan</option>
          <option value="sonstige">Sonstige</option>
        </select>
      </div>

      <div class="status-line">
        Unter 16 Jahren ist eine Zustimmung eines Erziehungsberechtigten erforderlich.  
        Ein Konto ist bis zur Zustimmung ‚Äûgesperrt‚Äú.
      </div>

      <div class="row">
        <button id="btn-signup">Registrieren</button>
        <button id="btn-login">Login</button>
        <button id="btn-logout">Logout</button>
      </div>

      <div class="status-line">
        <span id="auth-user"></span>
      </div>
      <div id="auth-lock-info" class="status-line"></div>
      <div id="auth-msg" class="status-line"></div>
      <div id="auth-approval-link" class="status-line"></div>
    </section>

    <!-- 2b. Profil / Rolle -->
    <section id="sec-profile" class="section-card">
      <h2><span>2b. Profil / Rolle</span></h2>
      <div class="row">
        <label for="prof-role">Rolle</label>
        <select id="prof-role">
          <option value="">Bitte w√§hlen‚Ä¶</option>
          <option value="trainer">Trainer</option>
          <option value="spieler">Aktiver Spieler</option>
          <option value="scout">Scout</option>
          <option value="eltern">Elternteil</option>
          <option value="zuschauer">Zuschauer / Fan</option>
          <option value="sonstige">Sonstige</option>
        </select>
      </div>
      <div class="row">
        <label for="prof-club" id="prof-club-label">Verein (optional)</label>
        <input id="prof-club" type="text" size="30">
      </div>
      <div class="row">
        <label for="prof-extra" id="prof-extra-label">Zusatzinfo (optional)</label>
        <input id="prof-extra" type="text" size="40" placeholder="">
      </div>
      <div class="row">
        <button id="btn-save-profile" type="button">Profil speichern</button>
      </div>
      <div id="prof-msg" class="status-line"></div>
    </section>

    <!-- 2a. Spieler anlegen + Events -->
    <section id="sec-rating" class="section-card">
      <h2><span>2a. Spieler & Events</span></h2>
            <h3>2a. Spieler suchen</h3>
      <div class="row">
        <label for="pl-search-name">Spielername</label>
        <input id="pl-search-name" type="text" size="30" placeholder="z.B. Elias Koch">
        <button id="btn-player-search" type="button">Spieler suchen</button>
      </div>
      <div id="pl-search-results" class="status-line"></div>

      <h3>2a. Spieler anlegen (manuell)</h3>
      <div class="row">
        <label for="pl-first">Vorname</label>
        <input id="pl-first" type="text" size="20">
      </div>
      <div class="row">
        <label for="pl-last">Nachname</label>
        <input id="pl-last" type="text" size="20">
      </div>
      <div class="row">
        <label for="pl-birth">Geburtsdatum</label>
        <input id="pl-birth" type="date">
      </div>
      <div class="row">
        <label for="pl-club-current">Aktueller Verein</label>
        <input id="pl-club-current" type="text" size="30" placeholder="z.B. FC 08 Villingen U17">
      </div>
      <div class="row">
        <label for="pl-club-prev">Verein vorher</label>
        <input id="pl-club-prev" type="text" size="30" placeholder="z.B. SC Freiburg Jugend">
      </div>
      <div class="row">
        <label for="pl-pos">Position(en)</label>
        <select id="pl-pos" multiple size="6">
          <option value="TW">TW (Torwart)</option>
          <option value="AV">AV (Au√üenverteidiger)</option>
          <option value="IV">IV (Innenverteidiger)</option>
          <option value="MF">MF (Mittelfeld)</option>
          <option value="AST">AST (Au√üenst√ºrmer)</option>
          <option value="MST">MST (Mittelst√ºrmer)</option>
        </select>
        <span style="font-size:0.8rem;">Strg/Cmd gedr√ºckt halten f√ºr Mehrfachauswahl.</span>
      </div>

      <div class="row">
        <label for="pl-foot">Starker Fu√ü</label>
        <select id="pl-foot">
          <option value="">Bitte w√§hlen‚Ä¶</option>
          <option value="left">links</option>
          <option value="right">rechts</option>
          <option value="both">beidf√º√üig</option>
        </select>
      </div>

      <div class="row">
        <label for="pl-number">R√ºckennummer</label>
        <input id="pl-number" type="number" min="1" max="99" style="width:80px;">
      </div>

      <div class="row">
        <button id="btn-create-player" type="button">Spieler speichern</button>
      </div>
      <div id="player-create-msg" class="status-line"></div>

      <!-- Punkt 3 ist jetzt in einem eigenen Reiter / Section -->

      <h3>3b. Ereignis suchen</h3>
      <div class="row">
        <label for="search-pairing">Paarung / Spiel</label>
        <input id="search-pairing" type="text" size="40"
          placeholder="z.B. FC 08 Villingen - SC Freiburg U17" />
        <button id="btn-search-event" type="button">Suchen</button>
      </div>
      <div id="event-results"></div>

      <p id="event-current" style="font-size:0.9rem; color:#555; margin-top:10px;">
        Kein Spiel ausgew√§hlt.
      </p>

      <h3>3d. Event-Details</h3>
      <div id="event-card" style="
        background:#fff;
        border-radius:8px;
        padding:10px 14px;
        box-shadow:0 1px 3px rgba(0,0,0,0.12);
        max-width:600px;
        font-size:0.9rem;
      ">
        <p style="margin:0; color:#555;">Kein Spiel ausgew√§hlt.</p>
      </div>

      <div id="event-create-msg" class="status-line"></div>
    </section>

    <!-- 3. Bewertung erfassen ‚Äì eigener Reiter -->
    <section id="sec-rating-form" class="section-card">
      <h2><span>3. Bewertung erfassen</span></h2>

      <div class="row">
        <label for="r-player">Spieler</label>
        <select id="r-player"></select>
      </div>

      <div class="row">
        <label for="r-event">Event</label>
        <select id="r-event"></select>
      </div>

      <h3>Kriterien (Schulnoten 1‚Äì6)</h3>
      <div id="criteria"></div>

      <h3>Kommentar</h3>
      <textarea id="r-comment" placeholder="Kurze Beschreibung der Leistung..."></textarea>

      <div class="row" style="margin-top:10px;">
        <button id="btn-add-rating">Bewertung speichern</button>
      </div>

      <div id="rate-msg" class="status-line"></div>
    </section>

    <!-- 7. SpielerRadar -->
    <section id="sec-radar" class="section-card">
      <h2><span>7. SpielerRadar‚Ñ¢ (Live-Aktionen)</span></h2>
      <p style="font-size:0.85rem; color:#555;">
        W√§hle ein Event und einen Spieler. Danach kannst du mit gro√üen + / ‚àí Buttons
        Live-Aktionen erfassen (Ballsicherheit, Zweikampf, Laufduell, Abschluss, Standards, Mentalit√§t, Fair Play).
      </p>

      <!-- Watchlist-Tabs -->
      <div id="radar-watchlist"
           style="margin-bottom:12px; display:flex; gap:8px; flex-wrap:wrap;">
        <!-- Tabs werden per JS eingef√ºgt -->
      </div>

      <div class="row">
        <label for="radar-event-select">Event / Spiel</label>
        <select id="radar-event-select">
          <option value="">Bitte w√§hlen ‚Ä¶</option>
        </select>
      </div>

      <div class="row">
        <label for="radar-player-select">Spieler</label>
        <select id="radar-player-select">
          <option value="">Bitte w√§hlen ‚Ä¶</option>
        </select>
      </div>
      
      <div class="row">
        <button id="radar-add-to-watchlist" type="button">Zur Watchlist hinzuf√ºgen</button>
        <button id="radar-start-btn" type="button">Radar starten</button>
      </div>

      <div id="radar-status" class="status-line"></div>

      <!-- BLOCK: Radar-Ranking-Tabelle -->
      <div id="radar-summary" style="margin-top:16px;">
        <h3>Radar-Ranking (dieses Spiel)</h3>
        <table id="radar-summary-table">
          <thead>
            <tr>
              <th>Spieler</th>
              <th>Gesamt</th>
              <th>Ballsich.</th>
              <th>Zweikampf</th>
              <th>Laufduell</th>
              <th>Abschluss</th>
              <th>Standards</th>
              <th>Mentalit√§t</th>
              <th>Fair Play</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="9">Noch keine Radar-Daten.</td></tr>
          </tbody>
        </table>
        <div id="radar-summary-msg" class="status-line small-note"></div>
      </div>

      <!-- BLOCK: Radar-Live-Aktionen-Panel -->
      <div id="radar-panel" class="radar-panel">
        <h3 id="radar-player-label" class="radar-player-label">Live-Aktionen</h3>
        <p class="small-note">
          W√§hrend des Spiels einfach + (gute Aktionen) oder ‚àí (nicht so gute) tippen.
        </p>

        <!-- Ballsicherheit -->
        <div class="radar-action-row" data-field="ballsicherheit">
          <div class="radar-cat">
            <span class="radar-cat-icon">üßç‚Äç‚ôÇÔ∏è‚öΩ</span>
            <span class="radar-cat-label">Ballsicherheit</span>
          </div>

          <div class="radar-buttons">
            <button type="button"
              class="radar-btn radar-btn-plus"
              data-field="ballsicherheit">
              ballsicher
            </button>
            <button type="button"
              class="radar-btn radar-btn-minus"
              data-field="ballsicherheit">
              Ballverlust
            </button>
          </div>

          <div class="radar-netto">
            <span class="radar-score" data-field="ballsicherheit">
              Netto: 0 ( +0 / ‚àí0 )
            </span>
          </div>
        </div>

        <!-- Zweikampf -->
        <div class="radar-action-row" data-field="zweikampf">
          <div class="radar-cat">
            <span class="radar-cat-icon">ü§º‚Äç‚ôÇÔ∏è</span>
            <span class="radar-cat-label">Zweikampf</span>
          </div>

          <div class="radar-buttons">
            <button type="button"
              class="radar-btn radar-btn-plus"
              data-field="zweikampf">
              gewonnen
            </button>
            <button type="button"
              class="radar-btn radar-btn-minus"
              data-field="zweikampf">
              verloren
            </button>
          </div>

          <div class="radar-netto">
            <span class="radar-score" data-field="zweikampf">
              Netto: 0 ( +0 / ‚àí0 )
            </span>
          </div>
        </div>

        <!-- Laufduell -->
        <div class="radar-action-row" data-field="laufduell">
          <div class="radar-cat">
            <span class="radar-cat-icon">üèÉ‚Äç‚ôÇÔ∏è</span>
            <span class="radar-cat-label">Laufduell</span>
          </div>

          <div class="radar-buttons">
            <button type="button"
              class="radar-btn radar-btn-plus"
              data-field="laufduell">
              gewonnen
            </button>
            <button type="button"
              class="radar-btn radar-btn-minus"
              data-field="laufduell">
              verloren
            </button>
          </div>

          <div class="radar-netto">
            <span class="radar-score" data-field="laufduell">
              Netto: 0 ( +0 / ‚àí0 )
            </span>
          </div>
        </div>

        <!-- Abschluss -->
        <div class="radar-action-row" data-field="abschluss">
          <div class="radar-cat">
            <span class="radar-cat-icon">ü•Ö</span>
            <span class="radar-cat-label">Abschluss</span>
          </div>

          <div class="radar-buttons">
            <button type="button"
              class="radar-btn radar-btn-plus"
              data-field="abschluss">
              guter Abschluss
            </button>
            <button type="button"
              class="radar-btn radar-btn-minus"
              data-field="abschluss">
              schlechter Abschluss
            </button>
          </div>

          <div class="radar-netto">
            <span class="radar-score" data-field="abschluss">
              Netto: 0 ( +0 / ‚àí0 )
            </span>
          </div>
        </div>

        <!-- Standards -->
        <div class="radar-action-row" data-field="standard">
          <div class="radar-cat">
            <span class="radar-cat-icon">üìê</span>
            <span class="radar-cat-label">Standards</span>
          </div>

          <div class="radar-buttons">
            <button type="button"
              class="radar-btn radar-btn-plus"
              data-field="standard">
              gut ausgef√ºhrt
            </button>
            <button type="button"
              class="radar-btn radar-btn-minus"
              data-field="standard">
              schwach
            </button>
          </div>

          <div class="radar-netto">
            <span class="radar-score" data-field="standard">
              Netto: 0 ( +0 / ‚àí0 )
            </span>
          </div>
        </div>

        <!-- Mentalit√§t -->
        <div class="radar-action-row" data-field="mentalitaet">
          <div class="radar-cat">
            <span class="radar-cat-icon">üî•</span>
            <span class="radar-cat-label">Mentalit√§t</span>
          </div>

          <div class="radar-buttons">
            <button type="button"
              class="radar-btn radar-btn-plus"
              data-field="mentalitaet">
              gezeigt
            </button>
            <button type="button"
              class="radar-btn radar-btn-minus"
              data-field="mentalitaet">
              gefehlt
            </button>
          </div>

          <div class="radar-netto">
            <span class="radar-score" data-field="mentalitaet">
              Netto: 0 ( +0 / ‚àí0 )
            </span>
          </div>
        </div>

        <!-- Fair Play -->
        <div class="radar-action-row" data-field="fairplay">
          <div class="radar-cat">
            <span class="radar-cat-icon">ü§ù</span>
            <span class="radar-cat-label">Fair Play</span>
          </div>

          <div class="radar-buttons">
            <button type="button"
              class="radar-btn radar-btn-plus"
              data-field="fairplay">
              fair
            </button>
            <button type="button"
              class="radar-btn radar-btn-minus"
              data-field="fairplay">
              unsportlich
            </button>
          </div>

          <div class="radar-netto">
            <span class="radar-score" data-field="fairplay">
              Netto: 0 ( +0 / ‚àí0 )
            </span>
          </div>
        </div>
      </div>
    </section> <!-- Ende sec-radar -->

    <!-- 4. Ranking -->
    <section id="sec-ranking" class="section-card">
      <h2><span>4. Ranking</span></h2>

      <div class="row">
        <label for="club-filter">Verein</label>
        <select id="club-filter"></select>
      </div>

      <div class="row">
        <label for="rank-pos">Position</label>
        <select id="rank-pos">
          <option value="">Alle</option>
          <option value="TW">TW</option>
          <option value="AV">AV</option>
          <option value="IV">IV</option>
          <option value="MF">MF</option>
          <option value="AST">AST</option>
          <option value="MST">MST</option>
        </select>

        <label for="rank-foot">Starker Fu√ü</label>
        <select id="rank-foot">
          <option value="">Alle</option>
          <option value="left">links</option>
          <option value="right">rechts</option>
          <option value="both">beidf√º√üig</option>
        </select>
      </div>

      <div class="row">
        <label for="rank-type">Event-Typ</label>
        <select id="rank-type">
          <option value="">Alle</option>
          <option value="match">Spiel</option>
          <option value="training">Training</option>
          <option value="tournament">Turnier</option>
        </select>
      </div>
     
      <div class="row">
        <label for="rank-source">Quelle</label>
        <select id="rank-source">
          <option value="rating">Bewertungen (Noten)</option>
          <option value="radar">Radar (Live-Aktionen)</option>
        </select>
      </div>

      <div class="row">
        <label for="rank-role">Bewertungs-Rolle</label>
        <select id="rank-role">
          <option value="">Alle</option>
          <option value="trainer">Trainer</option>
          <option value="scout">Scout</option>
          <option value="eltern">Eltern</option>
          <option value="spieler">Mitspieler</option>
          <option value="sonstige">Sonstige</option>
        </select>
      </div>

      <div class="row">
        <label for="rank-from">Von Datum</label>
        <input id="rank-from" type="date">
        <label for="rank-to">Bis Datum</label>
        <input id="rank-to" type="date">
      </div>

      <div class="row">
        <label for="rank-min">Min. Bewertungen</label>
        <input id="rank-min" type="number" value="1" min="0" style="width:70px;">
      </div>

      <div class="row">
        <label for="rank-q">Suche (Name/Verein)</label>
        <input id="rank-q" type="text" size="30">
      </div>

      <div class="row">
        <label for="fav-filter">Watchlist</label>
        <select id="fav-filter">
          <option value="">Alle</option>
          <option value="fav">Nur Favoriten</option>
        </select>
        <label>
          <input type="checkbox" id="rank-top10">
          nur Top 10
        </label>
        <button id="btn-refresh-ranking" type="button">Ranking aktualisieren</button>
        <button id="btn-export-csv" type="button">CSV-Export</button>
      </div>

      <div id="rank-msg" class="status-line"></div>

      <table id="rank-table">
        <thead>
          <tr>
            <th>‚òÖ</th>
            <th>Spieler</th>
            <th>Verein</th>
            <th>Pos</th>
            <th>Fu√ü</th>
            <th>#Bewertungen</th>
            <th>√ò Note</th>
            <th>Letztes Event</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="8">Noch keine Daten.</td></tr>
        </tbody>
      </table>
    </section>

    <!-- 5. Kalender-Import (ICS) -->
    <section id="sec-events" class="section-card">
      <h2><span>5. Kalender-Import (ICS)</span></h2>
      <div class="row">
        <label for="ics-file">ICS-Datei</label>
        <input id="ics-file" type="file" accept=".ics">
        <button id="btn-import-ics">Datei importieren</button>
      </div>
      <div class="row">
        <label for="ics-url">ICS-URL</label>
        <input id="ics-url" type="text" size="60" placeholder="https://.../kalender.ics">
        <button id="btn-import-ics-url">Von URL laden</button>
      </div>
      <div id="ics-msg" class="status-line"></div>
    </section>

    <!-- 6. Letzte Bewertungen -->
    <section id="sec-last" class="section-card">
      <h2><span>6. Letzte Bewertungen</span></h2>
      <table>
        <thead>
          <tr>
            <th>Datum</th>
            <th>Spieler</th>
            <th>Event</th>
            <th>Kommentar</th>
          </tr>
        </thead>
        <tbody id="last-ratings">
          <tr><td colspan="4">Noch keine Bewertungen.</td></tr>
        </tbody>
      </table>
    </section>
  </main>

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .catch(err => console.error('SW registration failed:', err));
    }
  </script>

   <!-- Navigation -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const buttons = Array.from(document.querySelectorAll('.top-nav button'));
      const sections = {
        'sec-config':       document.getElementById('sec-config'),
        'sec-auth':         document.getElementById('sec-auth'),
        'sec-profile':      document.getElementById('sec-profile'),
        'sec-rating':       document.getElementById('sec-rating'),
        'sec-rating-form':  document.getElementById('sec-rating-form'), // NEU
        'sec-radar':        document.getElementById('sec-radar'),
        'sec-ranking':      document.getElementById('sec-ranking'),
        'sec-events':       document.getElementById('sec-events'),
        'sec-last':         document.getElementById('sec-last')
      };

      function showSection(id) {
        Object.entries(sections).forEach(([key, el]) => {
          if (!el) return;
          el.style.display = (key === id) ? 'block' : 'none';
        });
        buttons.forEach(btn => {
          btn.classList.toggle('active', btn.dataset.target === id);
        });
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      window.npShowSection = showSection;

          buttons.forEach(btn => {
      btn.addEventListener('click', () => {
        const target = btn.dataset.target;
        if (target && sections[target]) {
          showSection(target);

          // Spezialf√§lle: beim √ñffnen Daten laden
          if (target === 'sec-ranking' && typeof refreshRanking === 'function') {
            refreshRanking();
          }
          if (target === 'sec-last' && typeof refreshLastComments === 'function') {
            refreshLastComments();
          }
        }
      });
    });

      // Start mit Setup
      showSection('sec-config');
    });
  </script>

  <!-- Supabase-Logik -->
  <script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.48.0/+esm';

  const $  = (sel) => document.querySelector(sel);
  const $$ = (sel) => Array.from(document.querySelectorAll(sel));

  function isUUID(v) {
    return typeof v === 'string' &&
      /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(v);
  }

  let supa = null;
  let currentUser = null;
  let currentUserMeta = null;
  let currentProfile = null;
  let currentEvent = null;
  let allEvents = [];
  // ... ab hier dein restlicher (funktionierender) Code

    // -----------------------------
    // Supabase-Konfiguration
    // -----------------------------
    function loadConfig() {
      return {
        url: localStorage.getItem('sb_url') || '',
        key: localStorage.getItem('sb_key') || ''
      };
    }

    function saveConfig(url, key) {
      localStorage.setItem('sb_url', url || '');
      localStorage.setItem('sb_key', key || '');
    }

    function resetClient() {
      supa = null;
    }

    function ensureClient() {
      const { url, key } = loadConfig();
      if (!url || !key) {
        const msg = $('#conf-msg');
        if (msg) msg.textContent = 'Bitte Supabase-URL und Anon-Key speichern.';
        throw new Error('Supabase-Konfiguration fehlt');
      }
      supa = createClient(url, key, {
        auth: { storageKey: 'scout-app-auth', multiTab: false }
      });
      return supa;
    }

    async function getClient() {
      if (supa) return supa;
      return ensureClient();
    }

    $('#btn-save-conf')?.addEventListener('click', () => {
      const url = ($('#sb-url')?.value || '').trim();
      const key = ($('#sb-key')?.value || '').trim();
      const msg = $('#conf-msg');
      if (!url || !key) {
        if (msg) msg.textContent = 'Bitte URL und Anon-Key eingeben.';
        return;
      }
      saveConfig(url, key);
      resetClient();
      if (msg) msg.textContent = 'Konfiguration gespeichert.';
    });

    $('#btn-test-conf')?.addEventListener('click', async () => {
      const msg = $('#conf-msg');
      if (msg) msg.textContent = 'Teste Verbindung‚Ä¶';

      const url = ($('#sb-url')?.value || '').trim();
      const key = ($('#sb-key')?.value || '').trim();
      if (url && key) {
        saveConfig(url, key);
        resetClient();
      }

      try {
        const c = await getClient();
        const { error } = await c.auth.getSession();
        if (error) {
          if (msg) msg.textContent = 'Fehler: ' + error.message;
        } else {
          if (msg) msg.textContent = 'OK: Verbindung funktioniert.';
        }
      } catch (e) {
        console.error(e);
        if (msg) msg.textContent = 'Verbindung fehlgeschlagen: ' + (e.message || e);
        resetClient();
      }
    });

    // -----------------------------
    // Auth & Jugendschutz
    // -----------------------------
    function updateAuthLockInfo() {
      const el = $('#auth-lock-info');
      const approvalBox = $('#auth-approval-link');
      if (!el) return;

      if (!currentUser) {
        el.innerHTML = '';
        if (approvalBox) approvalBox.innerHTML = '';
        return;
      }
      if (!currentUserMeta) {
        el.innerHTML = '‚ÑπÔ∏è Kein Altersprofil hinterlegt. Konto gilt als freigeschaltet (Testmodus).';
        return;
      }

      const year = currentUserMeta.birth_year;
      if (!year) {
        el.innerHTML = '‚ÑπÔ∏è Geburtsjahr fehlt im Profil.';
        return;
      }
      const nowYear = new Date().getFullYear();
      const age = nowYear - year;
      const minor = age < 16;

      if (minor && currentUserMeta.parent_required) {
        if (currentUserMeta.parent_approved) {
          el.innerHTML = `‚úÖ Konto freigeschaltet (minderj√§hrig, ca. ${age} Jahre, Elternzustimmung liegt vor).`;
        } else {
          el.innerHTML =
            `üîí Konto gesperrt (minderj√§hrig, ca. ${age} Jahre). ` +
            `Bitte Freigabelink an einen Erziehungsberechtigten senden.`;
        }
      } else if (minor) {
        el.innerHTML =
          `‚ÑπÔ∏è Minderj√§hrig (ca. ${age} Jahre) ‚Äì Elternzustimmung ist derzeit nicht als Pflicht markiert.`;
      } else {
        el.innerHTML =
          `‚úÖ Konto freigeschaltet (ca. ${age} Jahre, keine Elternzustimmung erforderlich).`;
      }
    }

    function isMinorLocked() {
      if (!currentUserMeta) return false;
      if (!currentUserMeta.parent_required) return false;
      const year = currentUserMeta.birth_year;
      if (!year) return false;
      const nowYear = new Date().getFullYear();
      const age = nowYear - year;
      return age < 16 && !currentUserMeta.parent_approved;
    }

    async function loadCurrentUser() {
      try {
        const c = await getClient();
        const { data } = await c.auth.getSession();
        currentUser = data?.session?.user || null;
        const elUser = $('#auth-user');
        if (elUser) {
          elUser.textContent = currentUser ? `Angemeldet: ${currentUser.email}` : '';
        }
      } catch (e) {
        console.error('loadCurrentUser', e);
        currentUser = null;
      }
    }

    async function loadUserMeta() {
      if (!currentUser) {
        currentUserMeta = null;
        updateAuthLockInfo();
        return;
      }
      try {
        const c = await getClient();
        const { data, error } = await c
          .from('user_profile')
          .select('id, nickname, birth_year, parent_email, parent_required, parent_approved')
          .eq('id', currentUser.id)
          .maybeSingle();

        if (!error && data) {
          currentUserMeta = data;
        } else {
          currentUserMeta = null;
        }
      } catch (e) {
        console.error('loadUserMeta', e);
        currentUserMeta = null;
      }
      updateAuthLockInfo();
    }

    function generateToken() {
      const arr = new Uint8Array(16);
      crypto.getRandomValues(arr);
      return Array.from(arr).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    async function ensureApprovalLinkForCurrentUser() {
      const approvalBox = $('#auth-approval-link');
      if (!currentUser || !currentUserMeta || !approvalBox) return;

      const childId = currentUserMeta.id || currentUser.id;

      let email =
        currentUserMeta.parent_email ||
        ($('#reg-parent-email')?.value || '').trim() ||
        currentUser.email ||
        '';

      if (!email) {
        console.warn('ensureApprovalLinkForCurrentUser: keine Eltern-Mail gefunden.');
        return;
      }

      try {
        const c = await getClient();

        const { data, error } = await c
          .from('parental_consent')
          .select('token, email')
          .eq('child_id', childId)
          .maybeSingle();

        let token;
        if (!error && data && data.token) {
          token = data.token;
          email = data.email || email;
        } else {
          token = generateToken();
          const { error: insErr } = await c
            .from('parental_consent')
            .insert({
              child_id: childId,
              token,
              email
            });
          if (insErr) {
            console.error('ensureApprovalLinkForCurrentUser insert error', insErr);
            return;
          }
        }

        const base = window.location.origin + window.location.pathname.replace(/index\.html$/, '');
        const link = `${base}approve.html?token=${token}`;

        const subject = encodeURIComponent('Einwilligung f√ºr NextPlayer‚Ñ¢');
        const body = encodeURIComponent(
          `Hallo,\n\n` +
          `bitte klicken Sie auf folgenden Link, um die Nutzung der App NextPlayer‚Ñ¢ f√ºr Ihr Kind zu erlauben:\n\n` +
          `${link}\n\n` +
          `Viele Gr√º√üe\nNextPlayer‚Ñ¢`
        );

        approvalBox.innerHTML =
          `Freigabelink: <a href="${link}" target="_blank">${link}</a><br>` +
          `<a href="mailto:${encodeURIComponent(email)}?subject=${subject}&body=${body}">` +
          `E-Mail mit diesem Link √∂ffnen</a>`;
      } catch (e) {
        console.error('ensureApprovalLinkForCurrentUser', e);
      }
    }

    // Registrierung
    $('#btn-signup')?.addEventListener('click', async () => {
      const email       = ($('#auth-email')?.value || '').trim();
      const pwd         = ($('#auth-pass')?.value || '').trim();
      const nick        = ($('#reg-nick')?.value || '').trim();
      const yearStr     = ($('#reg-year')?.value || '').trim();
      const regRole     = ($('#reg-role')?.value || '').trim();
      const parentEmail = ($('#reg-parent-email')?.value || '').trim();
      const msg         = $('#auth-msg');
      const approvalBox = $('#auth-approval-link');

      if (msg) msg.textContent = '';
      if (approvalBox) approvalBox.innerHTML = '';

      if (!email || !pwd) {
        if (msg) msg.textContent = 'Bitte E-Mail & Passwort eingeben.';
        return;
      }
      if (!nick || !yearStr) {
        if (msg) msg.textContent = 'Bitte K√ºnstlername und Geburtsjahr ausf√ºllen.';
        return;
      }
      if (!regRole) {
        if (msg) msg.textContent = 'Bitte eine Rolle f√ºr das Konto ausw√§hlen.';
        return;
      }

      const birthYear = parseInt(yearStr, 10);
      const nowYear   = new Date().getFullYear();
      if (isNaN(birthYear) || birthYear < 2000 || birthYear > nowYear) {
        if (msg) msg.textContent = 'Geburtsjahr ist nicht plausibel.';
        return;
      }
      const age            = nowYear - birthYear;
      const parentRequired = age < 16;

      if (parentRequired && !parentEmail) {
        if (msg) msg.textContent = 'F√ºr U16 ist eine Eltern-E-Mail erforderlich.';
        return;
      }

      try {
        const c = await getClient();
        const { data, error } = await c.auth.signUp({ email, password: pwd });
        if (error) {
          if (msg) msg.textContent = 'Fehler: ' + error.message;
          return;
        }

        const user = data?.user;
        if (!user) {
          if (msg) msg.textContent = 'Registrierung gestartet ‚Äì bitte E-Mail best√§tigen.';
          return;
        }

        const { error: profErr } = await c
          .from('user_profile')
          .insert({
            id: user.id,
            nickname: nick,
            birth_year: birthYear,
            parent_email: parentEmail || null,
            parent_required: parentRequired,
            parent_approved: parentRequired ? false : true
          });

        if (profErr) {
          console.error('user_profile insert', profErr);
          if (msg) msg.textContent = 'Konto erstellt, aber Profil (Alter) konnte nicht gespeichert werden.';
          return;
        }

        const { error: prof2Err } = await c
          .from('profile')
          .upsert({
            user_id: user.id,
            role: regRole,
            club_name: null,
            extra_info: null
          }, { onConflict: 'user_id' });

        if (prof2Err) {
          console.error('profile insert error', prof2Err);
          if (msg) msg.textContent = 'Konto angelegt, aber Profil-Rolle konnte nicht gespeichert werden.';
          return;
        }

        if (parentRequired) {
          const token = generateToken();
          const contactEmail = parentEmail || email;

          const { error: consentErr } = await c
            .from('parental_consent')
            .insert({
              child_id: user.id,
              token,
              email: contactEmail
            });

          if (consentErr) {
            console.error('parental_consent insert error', consentErr);
            if (msg) msg.textContent =
              'Registrierung erfolgreich. Konto ist gesperrt, aber Freigabelink konnte nicht gespeichert werden.';
            return;
          }

          const base = window.location.origin + window.location.pathname.replace(/index\.html$/, '');
          const link = `${base}approve.html?token=${token}`;

          const subject = encodeURIComponent('Einwilligung f√ºr NextPlayer‚Ñ¢');
          const body = encodeURIComponent(
            `Hallo,\n\n` +
            `bitte klicken Sie auf folgenden Link, um die Nutzung der App NextPlayer‚Ñ¢ f√ºr Ihr Kind zu erlauben:\n\n` +
            `${link}\n\n` +
            `Viele Gr√º√üe\nNextPlayer‚Ñ¢`
          );

          if (approvalBox) {
            approvalBox.innerHTML =
              `Freigabelink: <a href="${link}" target="_blank">${link}</a><br>` +
              `<a href="mailto:${encodeURIComponent(contactEmail)}?subject=${subject}&body=${body}">` +
              `E-Mail mit diesem Link √∂ffnen</a>`;
          }

          if (msg) msg.textContent =
            'Registrierung erfolgreich. Konto ist gesperrt, bis ein Erziehungsberechtigter zugestimmt hat.';
        } else {
          if (msg) msg.textContent = 'Registrierung erfolgreich. Du kannst dich jetzt einloggen.';
        }

      } catch (e) {
        console.error(e);
        const msg = $('#auth-msg');
        if (msg) msg.textContent = 'Fehler bei Registrierung.';
      }
    });

    // Login
    $('#btn-login')?.addEventListener('click', async () => {
      const email = ($('#auth-email')?.value || '').trim();
      const pwd   = ($('#auth-pass')?.value || '').trim();
      const msg   = $('#auth-msg');
      const approvalBox = $('#auth-approval-link');

      if (approvalBox) approvalBox.innerHTML = '';

      if (!email || !pwd) {
        if (msg) msg.textContent = 'Bitte E-Mail & Passwort eingeben.';
        return;
      }

      try {
        const c = await getClient();
        const { data, error } = await c.auth.signInWithPassword({ email, password: pwd });

        if (error) {
          if (msg) msg.textContent = 'Login fehlgeschlagen: ' + error.message;
          return;
        }

        currentUser = data?.user || null;
        const elUser = $('#auth-user');
        if (elUser) elUser.textContent = `Angemeldet: ${currentUser?.email || email}`;

        await loadUserMeta();
        await loadProfile();
        await refreshAllData();

        const locked = isMinorLocked();

        if (locked) {
          if (msg) msg.textContent =
            'Login OK, aber dein Konto ist noch gesperrt (Elternzustimmung fehlt).';

          await ensureApprovalLinkForCurrentUser();

          if (window.npShowSection) {
            window.npShowSection('sec-auth');
          }
          return;
        }

        if (msg) msg.textContent = 'Login OK.';
        if (window.npShowSection) {
          window.npShowSection('sec-rating');
        }

      } catch (e) {
        console.error(e);
        const msg = $('#auth-msg');
        if (msg) msg.textContent = 'Fehler beim Login.';
      }
    });

    // Logout
    $('#btn-logout')?.addEventListener('click', async () => {
      try {
        const c = await getClient();
        await c.auth.signOut();
      } catch (e) {
        console.error('logout error', e);
      }

      currentUser = null;
      currentUserMeta = null;
      currentProfile = null;
      currentEvent = null;

      const msg         = $('#auth-msg');
      const approvalBox = $('#auth-approval-link');
      const elUser      = $('#auth-user');
      const lockInfo    = $('#auth-lock-info');

      if (msg)        msg.textContent = 'Abgemeldet.';
      if (elUser)     elUser.textContent = '';
      if (approvalBox) approvalBox.innerHTML = '';
      if (lockInfo)  lockInfo.textContent = '';

      const idsToClear = [
        'auth-email',
        'auth-pass',
        'reg-nick',
        'reg-year',
        'reg-parent-email'
      ];
      idsToClear.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
      });
      const regRoleSel = document.getElementById('reg-role');
      if (regRoleSel) regRoleSel.value = '';

      const profRoleSel = document.getElementById('prof-role');
      const profClub    = document.getElementById('prof-club');
      const profExtra   = document.getElementById('prof-extra');

      if (profRoleSel) {
        profRoleSel.value = '';
        profRoleSel.disabled = false;
      }
      if (profClub)  profClub.value  = '';
      if (profExtra) profExtra.value = '';

      updateAuthLockInfo();

      if (window.npShowSection) {
        window.npShowSection('sec-auth');
      }
    });

    // -----------------------------
    // Profil / Rolle (2b)
    // -----------------------------
    function updateProfileFormForRole() {
      const roleSel   = document.getElementById('prof-role');
      const clubLabel = document.getElementById('prof-club-label');
      const extraLabel= document.getElementById('prof-extra-label');

      if (!roleSel || !clubLabel || !extraLabel) return;

      const role = roleSel.value;

      clubLabel.textContent  = 'Verein (optional)';
      extraLabel.textContent = 'Zusatzinfo (optional)';

      if (role === 'spieler') {
        clubLabel.textContent  = 'Aktueller Verein (Pflicht)';
        extraLabel.textContent = 'Zusatzinfo Spieler (z.B. Position, Liga, optional)';
      } else if (role === 'trainer') {
        clubLabel.textContent  = 'Verein als Trainer (Pflicht)';
        extraLabel.textContent = 'Lizenzangabe (optional, z.B. ‚ÄûUEFA B‚Äú)';
      } else if (role === 'scout') {
        clubLabel.textContent  = 'Verein / Organisation als Scout (optional)';
        extraLabel.textContent = 'Weitere Infos (optional)';
      } else if (role === 'eltern') {
        clubLabel.textContent  = 'Verein des Kindes (optional)';
        extraLabel.textContent = 'Weitere Infos (optional)';
      } else if (role === 'zuschauer') {
        clubLabel.textContent  = 'Lieblingsverein (optional)';
        extraLabel.textContent = 'Weitere Infos (optional)';
      }
    }

    document.getElementById('prof-role')?.addEventListener('change', updateProfileFormForRole);

    async function saveProfile() {
      const msg       = document.getElementById('prof-msg');
      const roleSel   = document.getElementById('prof-role');
      const clubInput = document.getElementById('prof-club');
      const extraInput= document.getElementById('prof-extra');

      if (!currentUser) {
        if (msg) msg.textContent = 'Bitte zuerst einloggen.';
        return;
      }
      if (isMinorLocked()) {
        if (msg) msg.textContent = 'Dein Konto ist noch nicht freigeschaltet (Elternzustimmung fehlt).';
        return;
      }

      let role = roleSel?.value || '';
      if (!role && currentProfile && currentProfile.role) {
        role = currentProfile.role;
      }
      if (!role) {
        if (msg) msg.textContent = 'Bitte eine Rolle ausw√§hlen.';
        return;
      }

      const club_name  = (clubInput?.value || '').trim();
      const extra_info = (extraInput?.value || '').trim();

      if ((role === 'spieler' || role === 'trainer') && !club_name) {
        if (msg) msg.textContent = 'Bitte den Verein angeben (Pflicht f√ºr Spieler & Trainer).';
        return;
      }

      try {
        const c = await getClient();
        const payload = {
          user_id: currentUser.id,
          role,
          club_name:  club_name  || null,
          extra_info: extra_info || null
        };

        const { data, error } = await c
          .from('profile')
          .upsert(payload, { onConflict: 'user_id' })
          .select('user_id, role, club_name, extra_info')
          .single();

        if (error) {
          console.error('saveProfile error', error);
          if (msg) msg.textContent = 'Fehler beim Speichern des Profils.';
          return;
        }

        currentProfile = data;
        if (msg) msg.textContent = 'Profil gespeichert.';

        updateProfileFormForRole();
        if (window.npShowSection) {
          window.npShowSection('sec-rating');
        }
      } catch (e) {
        console.error('saveProfile', e);
        if (msg) msg.textContent = 'Fehler beim Speichern.';
      }
    }

    document.getElementById('btn-save-profile')?.addEventListener('click', saveProfile);

    async function loadProfile() {
      if (!currentUser) {
        currentProfile = null;
        return;
      }
      try {
        const c = await getClient();
        const { data, error } = await c
          .from('profile')
          .select('user_id, role, club_name, extra_info')
          .eq('user_id', currentUser.id)
          .maybeSingle();

        if (!error && data) {
          currentProfile = data;

          const roleSel    = document.getElementById('prof-role');
          const clubInput  = document.getElementById('prof-club');
          const extraInput = document.getElementById('prof-extra');

          if (roleSel) {
            roleSel.value = data.role || '';
            if (data.role) {
              roleSel.disabled = true;
            }
          }
          if (clubInput)  clubInput.value  = data.club_name  || '';
          if (extraInput) extraInput.value = data.extra_info || '';

          updateProfileFormForRole();
        } else {
          currentProfile = null;
        }
      } catch (e) {
        console.error('loadProfile', e);
        currentProfile = null;
      }
    }

    // -----------------------------
    // Rating / Spieler / Events / Ranking / ICS / Verlauf
    // -----------------------------
    const ratingKeys = [
      ['technik','Technik'],
      ['taktik','Taktik'],
      ['intelligenz','Spielintelligenz'],
      ['handlung','Handlungsschnelligkeit'],
      ['mentalitaet','Mentalit√§t'],
      ['physis','Physis'],
      ['team','Teamverhalten'],
      ['konzentration','Konzentration'],
      ['kreativitaet','Kreativit√§t'],
      ['tempo','Spieltempo'],
      ['offensiv','Offensiv'],
      ['defensiv','Defensiv']
    ];
    const gradeSteps = ['1','1.5','2','2.5','3','3.5','4','4.5','5','5.5','6'];

    function gradeCells() {
      return gradeSteps.map(v => `<option value="${v}">${v}</option>`).join('');
    }

    function buildCriteriaUI() {
      const wrap = document.querySelector('#criteria');
      if (!wrap) return;
      wrap.innerHTML = '';
      ratingKeys.forEach(([key,label]) => {
        const div = document.createElement('div');
        div.style.minWidth = '150px';
        div.innerHTML = `
          <label>${label}</label>
          <select data-k="${key}">
            ${gradeCells()}
          </select>`;
        wrap.appendChild(div);
      });
    }
    buildCriteriaUI();

    async function createPlayerRating() {
      const msg = document.getElementById('player-create-msg');

      if (!currentUser) {
        if (msg) msg.textContent = 'Bitte zuerst einloggen.';
        return;
      }
      if (isMinorLocked()) {
        if (msg) msg.textContent = 'Dein Konto ist noch nicht freigeschaltet (Elternzustimmung fehlt).';
        return;
      }

      const first = (document.getElementById('pl-first')?.value || '').trim();
      const last  = (document.getElementById('pl-last')?.value  || '').trim();
      const birth = (document.getElementById('pl-birth')?.value || '').trim();
      const clubCur  = (document.getElementById('pl-club-current')?.value || '').trim();
      const clubPrev = (document.getElementById('pl-club-prev')?.value   || '').trim();
      const numStr   = (document.getElementById('pl-number')?.value      || '').trim();
      const posSel   = document.getElementById('pl-pos');
      const footSel  = document.getElementById('pl-foot');

      if (!first || !last) {
        if (msg) msg.textContent = 'Bitte mindestens Vor- und Nachname eingeben.';
        return;
      }

      const full = `${first} ${last}`.trim();
      const positions = posSel
        ? Array.from(posSel.selectedOptions).map(o => o.value)
        : [];

      try {
        const c = await getClient();

        const { data, error } = await c
          .from('player')
          .insert([{
            full_name: full,
            first_name: first,
            last_name: last,
            birthdate: birth || null,
            club_name: clubCur || null,
            prev_club: clubPrev || null,
            positions: positions.length ? positions : null,
            dominant_foot: footSel?.value || null,
            jersey_number: numStr ? parseInt(numStr, 10) : null
          }])

          .select('id')
          .single();

        if (error && error.code === '23505') {
          const { data: existing } = await c
            .from('player')
            .select('id')
            .eq('full_name', full)
            .eq('club_name', clubCur || null)
            .maybeSingle();

          const sel = document.getElementById('r-player');
          if (sel && existing?.id) {
            sel.value = existing.id;
          }

          if (msg) msg.textContent = 'Spieler existiert bereits ‚Äì wurde ausgew√§hlt.';
          return;
        }

        if (error) {
          console.error('createPlayer error', error);
          if (msg) msg.textContent = 'Fehler beim Speichern: ' + error.message;
          return;
        }

        if (msg) msg.textContent = 'Spieler gespeichert.';

        ['pl-first','pl-last','pl-birth','pl-club-current','pl-club-prev','pl-number']
          .forEach(id => {
            const el = document.getElementById(id);
            if (el) el.value = '';
          });
        if (posSel) Array.from(posSel.options).forEach(o => (o.selected = false));
        if (footSel) footSel.value = '';

        // Spielerlisten aktualisieren:
        // 1) f√ºr die normale Bewertung
        await refreshPlayers();
        // 2) f√ºr Vereinsfilter im Ranking
        await refreshClubFilter();
        // 3) f√ºr den Radar-Reiter (Dropdown)
        if (typeof radarRefreshData === 'function') {
          await radarRefreshData();
        }

        // neu angelegten Spieler direkt im Bewertungs-Dropdown ausw√§hlen
        const sel = document.getElementById('r-player');
        if (sel && data?.id) {
          sel.value = data.id;
        }
      } catch (e) {
        console.error('createPlayer', e);
        if (msg) msg.textContent = 'Fehler beim Speichern: ' + (e.message || e);
      }
    }

    document.getElementById('btn-create-player')?.addEventListener('click', createPlayerRating);

    async function refreshPlayers() {
      try {
        const c = await getClient();
       const { data, error } = await c
          .from('player')
          .select('id, full_name, club_name, jersey_number')
          .order('full_name');
        if (error) throw error;
        const sel = document.querySelector('#r-player');
        if (!sel) return;
        sel.innerHTML = (data || []).map(p => {
          const num = p.jersey_number ? `#${p.jersey_number} ` : '';
          const club = p.club_name || '';
          return `<option value="${p.id}">${num}${p.full_name} (${club})</option>`;
        }).join('');
      } catch (e) {
        console.error('refreshPlayers', e);
      }
    }

    async function refreshClubFilter() {
      try {
        const c = await getClient();
        const { data, error } = await c
          .from('player')
          .select('club_name');
        if (error) throw error;
        const clubs = Array.from(
          new Set(
            (data || [])
              .map(x => (x.club_name || '').trim())
              .filter(Boolean)
          )
        ).sort();
        const sel = document.querySelector('#club-filter');
        if (!sel) return;
        sel.innerHTML =
          '<option value="">Alle</option>' +
          clubs.map(cc => `<option value="${cc}">${cc}</option>`).join('');
      } catch (e) {
        console.error('refreshClubFilter', e);
      }
    }

    // Events aus echter DB (f√ºr Ranking, Verlauf & Karte 3)
    async function refreshEvents() {
      try {
        const c = await getClient();
        const { data, error } = await c
          .from('event')
          .select('id, event_date, type, competition, opponent, subtype, location')
          .order('event_date', { ascending: false });
        if (error) throw error;
        allEvents = data || [];

        const sel = document.querySelector('#r-event');
        if (!sel) return;
        sel.innerHTML = '<option value="">Bitte Event w√§hlen‚Ä¶</option>' +
          allEvents.map(ev => {
            const label = formatEventDisplayLine(ev);
            return `<option value="${ev.id}">${label}</option>`;
          }).join('');
      } catch (e) {
        console.error('refreshEvents', e);
      }
    }
   
    // -----------------------------
    // Spieler-Suche in "Spieler & Events" mit Mini-Vorschau
    // -----------------------------
    function formatFootLabel(foot) {
      if (foot === 'left') return 'links';
      if (foot === 'right') return 'rechts';
      if (foot === 'both') return 'beidf√º√üig';
      return '';
    }

    function formatAgeLabel(birthdate) {
      if (!birthdate) return '';
      const year = parseInt(String(birthdate).slice(0, 4), 10);
      if (!year || isNaN(year)) return '';
      const nowYear = new Date().getFullYear();
      const age = nowYear - year;
      if (age < 5 || age > 60) return ''; // unrealistische Werte ausblenden
      return `${age} J.`;
    }

    async function searchPlayerByName() {
      const nameInput = document.getElementById('pl-search-name');
      const resultBox = document.getElementById('pl-search-results');
      if (!nameInput || !resultBox) return;

      const term = (nameInput.value || '').trim();
      if (!term) {
        resultBox.textContent = 'Bitte einen Spielernamen eingeben.';
        return;
      }

      resultBox.textContent = 'Suche l√§uft‚Ä¶';

      try {
        const c = await getClient();
        const { data, error } = await c
          .from('player')
          .select('id, full_name, club_name, positions, jersey_number, dominant_foot, birthdate')
          .ilike('full_name', `%${term}%`)
          .order('full_name', { ascending: true });

        if (error) throw error;

        // Nichts gefunden ‚Üí automatisch zum Formular "Spieler anlegen" scrollen
        if (!data || !data.length) {
          resultBox.textContent =
            'Kein Spieler gefunden. Du kannst unten einen neuen Spieler anlegen.';
          const firstInput = document.getElementById('pl-first');
          if (firstInput) {
            firstInput.scrollIntoView({ behavior: 'smooth', block: 'start' });
            setTimeout(() => firstInput.focus(), 400);
          }
          return;
        }

        // Trefferliste aufbauen (mit Mini-Vorschau)
        const ul = document.createElement('ul');
        ul.style.listStyle = 'none';
        ul.style.padding = '0';
        ul.style.margin = '4px 0';

        data.forEach(p => {
          const li = document.createElement('li');
          li.style.marginBottom = '4px';

          const btn = document.createElement('button');
          btn.type = 'button';
          btn.style.padding = '4px 8px';
          btn.style.cursor = 'pointer';
          btn.style.width = '100%';
          btn.style.textAlign = 'left';

          // Hauptzeile: #Nr Name (Verein)
          const num = p.jersey_number ? `#${p.jersey_number} ` : '';
          const club = p.club_name ? ` (${p.club_name})` : '';
          const title = document.createElement('div');
          title.style.fontWeight = '600';
          title.textContent = `${num}${p.full_name}${club}`;

          // Zweite Zeile: Pos ‚Ä¢ Fu√ü ‚Ä¢ Alter
          const posArr = Array.isArray(p.positions)
            ? p.positions
            : (typeof p.positions === 'string'
                ? p.positions.split(',').map(x => x.trim()).filter(Boolean)
                : []);
          const posStr = posArr.length ? posArr.join(', ') : '';
          const footStr = formatFootLabel(p.dominant_foot);
          const ageStr = formatAgeLabel(p.birthdate);

          const metaParts = [];
          if (posStr) metaParts.push(`Pos: ${posStr}`);
          if (footStr) metaParts.push(`Fu√ü: ${footStr}`);
          if (ageStr) metaParts.push(ageStr);

          const meta = document.createElement('div');
          meta.style.fontSize = '0.8rem';
          meta.style.color = '#555';
          meta.textContent = metaParts.join(' ‚Ä¢ ');

          btn.appendChild(title);
          btn.appendChild(meta);

          btn.addEventListener('click', () => {
            // Spieler in Bewertungs-Dropdown setzen
            const ratingSel = document.getElementById('r-player');
            if (ratingSel) {
              ratingSel.value = p.id;
            }

            // Spieler in Radar-Dropdown setzen (optional)
            const radarSel = document.getElementById('radar-player-select');
            if (radarSel) {
              radarSel.value = p.id;
            }

            resultBox.textContent = `Spieler "${p.full_name}" wurde ausgew√§hlt.`;
            // Optional: direkt zum Reiter "Bewertung" springen
            // if (window.npShowSection) window.npShowSection('sec-rating-form');
          });

          li.appendChild(btn);
          ul.appendChild(li);
        });

        resultBox.innerHTML = '';
        resultBox.appendChild(ul);

      } catch (e) {
        console.error('searchPlayerByName', e);
        const resultBox2 = document.getElementById('pl-search-results');
        if (resultBox2) {
          resultBox2.textContent = 'Fehler bei der Spielersuche.';
        }
      }
    }

    // Events f√ºr Suchfeld
    document.getElementById('btn-player-search')?.addEventListener('click', searchPlayerByName);
    document.getElementById('pl-search-name')?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        searchPlayerByName();
      }
    });
    
    // Bewertung speichern
    document.querySelector('#btn-add-rating')?.addEventListener('click', async () => {
      try {
        const c = await getClient();
        const sessionRes = await c.auth.getSession();
        const user = sessionRes?.data?.session?.user || null;
        const msg = document.querySelector('#rate-msg');

        if (!user) {
          const m = document.querySelector('#auth-msg');
          if (m) m.textContent = 'Bitte zuerst einloggen.';
          return;
        }
        if (isMinorLocked()) {
          if (msg) msg.textContent = 'Dein Konto ist noch nicht freigeschaltet (Elternzustimmung fehlt).';
          return;
        }

        if (!currentProfile || !currentProfile.role) {
          if (msg) msg.textContent = 'Bitte zuerst im Profil (2b) deine Rolle ausw√§hlen und speichern.';
          return;
        }

        const playerSel = document.querySelector('#r-player');
        const eventSel  = document.querySelector('#r-event');
        const commentEl = document.querySelector('#r-comment');

        const player_id = playerSel?.value || null;
        const dropdownEventId = eventSel?.value || null;
        let   event_id  = (currentEvent && currentEvent.id) ? currentEvent.id : dropdownEventId;

        if (!event_id) {
          if (msg) msg.textContent = 'Bitte zuerst ein Event ausw√§hlen (3b/3c oder Event-Dropdown).';
          return;
        }

        // falls currentEvent noch nicht gesetzt ist ‚Üí aus allEvents nachladen
        if (!currentEvent && dropdownEventId) {
          const ev = allEvents.find(e => String(e.id) === String(dropdownEventId));
          if (ev) {
            setCurrentEvent(ev);
            event_id = ev.id;
          } else {
            console.warn('Kein DB-Event gefunden f√ºr ID', dropdownEventId);
          }
        }

        if (!player_id) {
          if (msg) msg.textContent = 'Bitte einen Spieler ausw√§hlen (oder in 2a neu anlegen).';
          return;
        }

        // Nur echte UUIDs speichern ‚Äì keine Demo-IDs wie "E013"
        if (!isUUID(String(event_id))) {
          if (msg) msg.textContent =
            'Fehler: Dieses Event hat keine g√ºltige ID (z.B. Demo-Event ‚ÄûE007‚Äú). ' +
            'Bitte ein Event aus der Datenbank ausw√§hlen oder in 3c neu anlegen.';
          console.warn('Skip DB insert, invalid UUID for event_id:', event_id);
          return;
        }

        const comment = (commentEl?.value || '').trim();

        const crit = {};
        ratingKeys.forEach(([k]) => {
          const sel = document.querySelector(`select[data-k="${k}"]`);
          const v = parseFloat(sel?.value);
          crit[k] = isNaN(v) ? null : v;
        });

        const roleForRating = currentProfile.role || '';
        crit._role  = roleForRating;
        crit._rater = user.email || '';

        const payload = {
          rater_id: user.id,
          player_id,
          event_id,
          criteria: crit,
          comment
        };

        const { error } = await c
          .from('rating')
          .upsert(payload, {
            onConflict: 'rater_id,player_id,event_id'
          });

        if (error) {
          console.error('upsert rating error', error);
          if (msg) msg.textContent = 'Fehler: ' + error.message;
        } else {
          if (msg) msg.textContent = 'Bewertung gespeichert (ggf. aktualisiert).';
          await refreshRanking();
          await refreshLastComments();
        }
      } catch (e) {
        console.error('save rating', e);
        const msg = document.querySelector('#rate-msg');
        if (msg) msg.textContent = 'Fehler beim Speichern.';
      }
    });

    // -----------------------------
    // Event-Suche f√ºr 3b. Ereignis suchen
    // -----------------------------
    async function searchEventsByTerm(term) {
      try {
        const c = await getClient();

        let query = c
          .from('event')
          .select('id, event_date, type, competition, opponent, subtype, location')
          .order('event_date', { ascending: false })
          .limit(50);

        term = (term || '').trim();
        if (term) {
          const orFilter =
            `competition.ilike.%${term}%,` +
            `opponent.ilike.%${term}%,` +
            `subtype.ilike.%${term}%,` +
            `location.ilike.%${term}%`;
          query = query.or(orFilter);
        }

        const { data, error } = await query;
        if (error) throw error;

        // Duplikate nach Inhalt entfernen
        const unique = [];
        const seen = new Set();
        for (const ev of data || []) {
          const key = [
            ev.event_date || '',
            ev.type || '',
            ev.competition || '',
            ev.opponent || '',
            ev.location || ''
          ].join('|');
          if (seen.has(key)) continue;
          seen.add(key);
          unique.push(ev);
        }

        renderEventResults(unique);
      } catch (e) {
        console.error('searchEventsByTerm', e);
        const box = document.querySelector('#event-results');
        if (box) box.textContent = 'Fehler bei der Suche.';
      }
    }

    function formatEventPairing(ev) {
      if (ev.competition || ev.opponent) {
        const home = (ev.competition || '').trim();
        const away = (ev.opponent || '').trim();
        if (home && away) return `${home} - ${away}`;
        if (home) return home;
        if (away) return away;
      }
      if (ev.subtype) return ev.subtype;
      return `Event ${ev.id}`;
    }

    function formatEventDisplayLine(ev) {
      const parts = [];
      if (ev.event_date) parts.push(ev.event_date);
      if (ev.type)       parts.push(ev.type);
      const pairing = formatEventPairing(ev);
      if (pairing)      parts.push(pairing);
      if (ev.location)  parts.push(ev.location);
      return parts.join(' | ');
    }

    function renderEventResults(list) {
      const box   = document.querySelector('#event-results');
      const label = document.querySelector('#event-current');
      const card  = document.querySelector('#event-card');
      if (!box) return;

      if (!list.length) {
        box.textContent = 'Keine Spiele gefunden.';
        if (label) label.textContent = 'Kein Spiel ausgew√§hlt.';
        if (card) {
          card.innerHTML = '<p style="margin:0; color:#555;">Kein Spiel ausgew√§hlt.</p>';
        }
        return;
      }

      const ul = document.createElement('ul');
      ul.style.listStyle = 'none';
      ul.style.padding = '0';
      ul.style.margin = '0';

      list.forEach(ev => {
        const li = document.createElement('li');
        li.style.marginBottom = '6px';

        const btn = document.createElement('button');
        btn.type = 'button';
        btn.style.padding = '4px 8px';
        btn.style.cursor = 'pointer';
        btn.style.width = '100%';
        btn.style.textAlign = 'left';

        btn.textContent = formatEventDisplayLine(ev);

        btn.addEventListener('click', () => {
          setCurrentEvent(ev);
        });

        li.appendChild(btn);
        ul.appendChild(ul.lastChild || li);
        if (li.parentNode !== ul) ul.appendChild(li);
      });

      box.innerHTML = '';
      box.appendChild(ul);
    }

    function setCurrentEvent(ev) {
      currentEvent = ev;

      const label = document.querySelector('#event-current');
      if (label) {
        let pairing = '';
        if (ev.competition || ev.opponent) {
          pairing = `${ev.competition || ''} - ${ev.opponent || ''}`.trim();
        } else if (ev.subtype) {
          pairing = ev.subtype;
        } else {
          pairing = `Event ${ev.id}`;
        }
        const dateStr = ev.event_date ? ` am ${ev.event_date}` : '';
        label.textContent = `Aktuell ausgew√§hltes Spiel: ${pairing}${dateStr}`;
      }

      const card = document.querySelector('#event-card');
      if (card && ev) {
        const pairing = formatEventPairing(ev);
        const dateStr = ev.event_date || '';
        const typeStr = ev.type || '';
        const locStr  = ev.location || '';
        const extra   = ev.subtype || '';

        card.innerHTML = `
          <div style="font-size:0.95rem; font-weight:600; margin-bottom:4px;">
            ${pairing}
          </div>
          <div style="font-size:0.85rem; color:#555; margin-bottom:2px;">
            Datum: ${dateStr}
          </div>
          <div style="font-size:0.85rem; color:#555; margin-bottom:2px;">
            Typ: ${typeStr}${extra ? ' (' + extra + ')' : ''}
          </div>
          <div style="font-size:0.85rem; color:#555; margin-bottom:2px;">
            Ort: ${locStr}
          </div>
          <div style="font-size:0.8rem; color:#777;">
            Event-ID: ${ev.id}
          </div>
        `;
      }

      const sel = document.querySelector('#r-event');
      if (sel && ev.id) {
        const opt = sel.querySelector(`option[value="${ev.id}"]`);
        if (opt) sel.value = String(ev.id);
      }
    }

    // Suchfeld + Button (3b. Ereignis suchen)
    const inpPairing = document.querySelector('#search-pairing');
    const btnSearchEvent = document.querySelector('#btn-search-event');

    if (btnSearchEvent && inpPairing) {
      btnSearchEvent.addEventListener('click', () => {
        const term = (inpPairing.value || '').trim();
        searchEventsByTerm(term);
      });

      inpPairing.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          const term = (inpPairing.value || '').trim();
          searchEventsByTerm(term);
        }
      });
    }

    // Wechsel im Event-Dropdown ‚Üí currentEvent aktualisieren
    const selEvent = document.querySelector('#r-event');
    if (selEvent) {
      selEvent.addEventListener('change', () => {
        const id = selEvent.value;
        const ev = allEvents.find(e => String(e.id) === id);
        if (ev) setCurrentEvent(ev);
      });
    }

    // -----------------------------
    // Ranking / CSV / ICS / Verlauf / Event anlegen
    // -----------------------------
    function loadFavSet() {
      try {
        const raw = localStorage.getItem('fav_players') || '[]';
        const arr = JSON.parse(raw);
        return new Set(Array.isArray(arr) ? arr : []);
      } catch {
        return new Set();
      }
    }
    function saveFavSet(set) {
      localStorage.setItem('fav_players', JSON.stringify([...set]));
    }
    
    // -----------------------------
    // Ranking neu & robuster
    // -----------------------------
    let favSet   = loadFavSet();
    let lastRows = [];
    let ratingsByPlayer = new Map();

    async function refreshRankingFromRating(filters) {
  // dein bisheriger gro√üer Block bleibt hier drin
  // statt Filter direkt aus dem DOM zu lesen, benutzen wir 'filters'
}

        // Haupt-Funktion, die von au√üen aufgerufen wird
    async function refreshRanking() {
      const sourceSel = document.getElementById('rank-source');
      const source = sourceSel ? (sourceSel.value || 'rating') : 'rating';

      // Hier k√∂nntest du sp√§ter die Filter einmal zentral einsammeln
      // und an beide Varianten √ºbergeben. Vorerst lassen wir die alte
      // Rating-Funktion ihre Filter selber aus dem DOM lesen.
      const filters = {}; // Platzhalter f√ºr sp√§tere Erweiterungen

      if (source === 'radar') {
        await refreshRankingFromRadar(filters);
      } else {
        await refreshRankingFromRating(filters);
      }
    }

        // -----------------------------
    // Radar-basiertes Ranking (global √ºber Events)
    // -----------------------------
    async function refreshRankingFromRadar(filters) {
      const msg  = document.querySelector('#rank-msg');
const tbody = document.querySelector('#rank-table tbody');

if (!tbody) {
  console.warn('Ranking-Tabelle (#rank-table tbody) nicht gefunden.');
  throw new Error('Ranking-Tabelle (#rank-table tbody) nicht gefunden.');
}

if (msg) msg.textContent = 'Lade Ranking-Daten‚Ä¶';

try {
  const c = await getClient();
  // ... dein weiterer Code bleibt wie er ist ...

        // Events und Radar-Daten laden
        const [pRes, eRes, rRes] = await Promise.all([
          c.from('player')
            .select('id, full_name, club_name, positions, dominant_foot'),
          c.from('event')
            .select('id, event_date, type, competition, opponent, subtype, location'),
          c.from('player_radar')
            .select('*')
        ]);

let players = [];
let events  = [];
let ratings = [];

if (pRes.error || eRes.error || rRes.error) {
  console.error('refreshRanking errors:', pRes.error, eRes.error, rRes.error);
  if (msg) msg.textContent = 'Fehler beim Laden der Daten (Player/Event/Rating).';
  tbody.innerHTML = '<tr><td colspan="8">Fehler beim Laden der Daten.</td></tr>';
} else {
  players = pRes.data || [];
  events  = eRes.data || [];
  ratings = rRes.data || [];
}

        const players = pRes.data || [];
        const events  = eRes.data || [];
        const radar   = rRes.data || [];

        if (!radar.length) {
          if (msg) msg.textContent = 'Noch keine Radar-Daten in der Datenbank.';
          tbody.innerHTML = '<tr><td colspan="8">Noch keine Radar-Daten gespeichert.</td></tr>';
          return;
        }

        const pMap = new Map(players.map(p => [p.id, p]));
        const eMap = new Map(events.map(e => [e.id, e]));

        // Filter aus dem Ranking-UI (k√∂nnen sp√§ter ins filters-Objekt wandern)
        const clubF   = document.querySelector('#club-filter')?.value || '';
        const posF    = document.querySelector('#rank-pos')?.value || '';
        const footF   = document.querySelector('#rank-foot')?.value || '';
        const typeF   = document.querySelector('#rank-type')?.value || '';
        const fromF   = document.querySelector('#rank-from')?.value || '';
        const toF     = document.querySelector('#rank-to')?.value || '';
        const q       = (document.querySelector('#rank-q')?.value || '').toLowerCase();
        const minR    = parseInt(document.querySelector('#rank-min')?.value || '0', 10) || 0;

        const agg = new Map();

        // 1) Radar-Daten pro Spieler aggregieren
        radar.forEach(row => {
          const pl = pMap.get(row.rated_player_id);
          const ev = eMap.get(row.event_id);
          if (!pl || !ev) return;

          const d = (ev.event_date || '').slice(0,10);

          if (typeF && ev.type !== typeF) return;
          if (fromF && d < fromF) return;
          if (toF   && d > toF)   return;

          const club = pl.club_name || '';
          const pos  = pl.positions || null;
          const foot = pl.dominant_foot || '';

          // Grobe Filter auf Spielerebene
          if (clubF && club !== clubF) return;

          const posArr = Array.isArray(pos)
            ? pos
            : (typeof pos === 'string'
                ? pos.split(',').map(x => x.trim()).filter(Boolean)
                : []);
          if (posF && !posArr.includes(posF)) return;

          if (footF && foot !== footF) return;

          const nameLower = (pl.full_name || '').toLowerCase();
          if (q && !nameLower.includes(q) && !club.toLowerCase().includes(q)) return;

          const key = row.rated_player_id;
          let stat = agg.get(key);
          if (!stat) {
            stat = {
              cntEvents: 0,
              ballsich: 0,
              zweik: 0,
              lauf: 0,
              abschluss: 0,
              std: 0,
              ment: 0,
              fair: 0
            };
          }

          const nets = f => (row[`${f}_plus`] || 0) - (row[`${f}_minus`] || 0);

          stat.cntEvents += 1;
          stat.ballsich  += nets('ballsicherheit');
          stat.zweik     += nets('zweikampf');
          stat.lauf      += nets('laufduell');
          stat.abschluss += nets('abschluss');
          stat.std       += nets('standard');
          stat.ment      += nets('mentalitaet');
          stat.fair      += nets('fairplay');

          agg.set(key, stat);
        });

        // 2) in Array umwandeln
        let rows = [];
        for (const [playerId, st] of agg.entries()) {
          if (st.cntEvents < minR) continue;

          const pl = pMap.get(playerId) || {
            full_name: playerId,
            club_name: '',
            positions: null,
            dominant_foot: null
          };

          const total =
            st.ballsich +
            st.zweik +
            st.lauf +
            st.abschluss +
            st.std +
            st.ment +
            st.fair;

          rows.push({
            id:    playerId,
            name:  pl.full_name,
            club:  pl.club_name || '',
            pos:   pl.positions || null,
            foot:  pl.dominant_foot || '',
            cntEvents: st.cntEvents,
            ballsich:  st.ballsich,
            zweik:     st.zweik,
            lauf:      st.lauf,
            abschluss: st.abschluss,
            std:       st.std,
            ment:      st.ment,
            fair:      st.fair,
            total
          });
        }

        if (!rows.length) {
          tbody.innerHTML = '<tr><td colspan="8">Keine Spieler f√ºr die aktuellen Filter (Radar).</td></tr>';
          if (msg) msg.textContent = 'Keine Spieler ‚Äì ggf. Filter anpassen oder mehr Radar-Daten erfassen.';
          return;
        }

        // 3) Sortierung nach Radar-Score (total)
        rows.sort((a, b) => b.total - a.total);

        const footLabel = f =>
          f === 'left' ? 'links' :
          f === 'right' ? 'rechts' :
          f === 'both' ? 'beidf√º√üig' : '';

        const posStr = p =>
          Array.isArray(p) ? p.join(', ') :
          (typeof p === 'string' ? p : '');

        // 4) Tabelle bauen ‚Äì wir nutzen vorhandene Spalten,
        //  interpretieren aber √ò Note hier als Gesamt-Radarwert.
        tbody.innerHTML = rows.map(r => `
          <tr>
            <td>‚òÖ</td>
            <td>${r.name}</td>
            <td>${r.club}</td>
            <td>${posStr(r.pos)}</td>
            <td>${footLabel(r.foot)}</td>
            <td>${r.cntEvents}</td>
            <td>${r.total}</td>
            <td>Radar</td>
          </tr>
        `).join('');

        if (msg) msg.textContent = `OK: ${rows.length} Spieler im Radar-Ranking (Quelle: Live-Aktionen).`;

      } catch (e) {
        console.error('refreshRankingFromRadar', e);
        const msg = document.querySelector('#rank-msg');
        if (msg) msg.textContent = 'Fehler beim Laden des Radar-Rankings.';
        const tbody = document.querySelector('#rank-table tbody');
        if (tbody) tbody.innerHTML = '<tr><td colspan="8">Fehler beim Radar-Ranking.</td></tr>';
      }
    }

const msg  = document.querySelector('#rank-msg');
const tbody = document.querySelector('#rank-table tbody');

// Wenn es keine Ranking-Tabelle gibt, nur warnen und hier STOPPEN,
// aber OHNE "return" (das ist am Top-Level verboten).
if (!tbody) {
  console.warn('Ranking-Tabelle (#rank-table tbody) nicht gefunden ‚Äì refreshRanking wird √ºbersprungen.');
} else {

  if (msg) msg.textContent = 'Lade Ranking-Daten‚Ä¶';

  try {
    const c = await getClient();

    // 1) Basisdaten holen
    const [pRes, eRes, rRes] = await Promise.all([
      c.from('player').select('id, full_name, club_name, positions, dominant_foot, birthdate'),
      c.from('event').select('id, event_date, type, competition, opponent, subtype, location'),
      c.from('rating')
        .select('player_id, event_id, criteria, created_at')
        .order('created_at', { ascending: false })
        .limit(2000)
    ]);
    
        if (pRes.error || eRes.error || rRes.error) {
      console.error('refreshRanking errors:', pRes.error, eRes.error, rRes.error);
      if (msg) msg.textContent = 'Fehler beim Laden der Daten (Player/Event/Rating).';
      tbody.innerHTML = '<tr><td colspan="8">Fehler beim Laden der Daten.</td></tr>';
    }

        const players = pRes.data || [];
        const events  = eRes.data || [];
        const ratings = rRes.data || [];

// Falls es √ºberhaupt keine Ratings gibt, fr√ºh abbrechen ‚Äì aber ohne return
if (!ratings.length) {
  if (msg) msg.textContent = 'Noch keine Bewertungen in der Datenbank.';
  tbody.innerHTML = '<tr><td colspan="8">Noch keine Bewertungen vorhanden.</td></tr>';
  lastRows = [];
  ratingsByPlayer = new Map();
} else {
  lastRows = [];
  ratingsByPlayer = new Map();

  const pMap = new Map(players.map(p => [p.id, p]));
  const eMap = new Map(events.map(e => [e.id, e]));

  // ‚¨áÔ∏è ab hier dein bisheriger Ranking-Code (Filtern, Sortieren, rows.map(...) etc.)
}

        // 2) Filter auslesen
        const clubF   = document.querySelector('#club-filter')?.value || '';
        const posF    = document.querySelector('#rank-pos')?.value || '';
        const footF   = document.querySelector('#rank-foot')?.value || '';
        const typeF   = document.querySelector('#rank-type')?.value || '';
        const roleF   = (document.querySelector('#rank-role')?.value || '').toLowerCase();
        const fromF   = document.querySelector('#rank-from')?.value || '';
        const toF     = document.querySelector('#rank-to')?.value || '';
        const q       = (document.querySelector('#rank-q')?.value || '').toLowerCase();
        const minR    = parseInt(document.querySelector('#rank-min')?.value || '0', 10) || 0;
        const favMode = document.querySelector('#fav-filter')?.value || 'all';
        const topOnly = document.querySelector('#rank-top10')?.checked;

        const agg = new Map();
        ratingsByPlayer = new Map();

        // 3) Ratings pro Spieler aggregieren
        for (const r of ratings) {
          const ev = eMap.get(r.event_id);
          const pl = pMap.get(r.player_id);
          if (!ev || !pl) continue;

          const critObj = r.criteria || {};
          const roleVal = (critObj._role || '').toLowerCase();

          if (roleF && roleF !== 'alle' && roleVal !== roleF) continue;

          const d = (ev.event_date || '').slice(0, 10);

          if (typeF && ev.type !== typeF) continue;
          if (fromF && d < fromF) continue;
          if (toF   && d > toF)   continue;

          // √ò-Note aus Kriterien berechnen
          const vals = Object.entries(critObj)
            .map(([k, v]) => k.startsWith('_') ? NaN : Number(v))
            .filter(n => Number.isFinite(n));

          if (!vals.length) continue;
          const avg = vals.reduce((a, b) => a + b, 0) / vals.length;

          // Liste der Einzelratings pro Spieler (f√ºr Detailanzeige)
          let list = ratingsByPlayer.get(r.player_id);
          if (!list) {
            list = [];
            ratingsByPlayer.set(r.player_id, list);
          }
          list.push({
            avg,
            created_at: r.created_at || '',
            event_date: ev.event_date || '',
            event_type: ev.type || '',
            event_name: formatEventPairing(ev),
            role:       critObj._role  || '',
            rater:      critObj._rater || ''
          });

          // Aggregation
          const key = r.player_id;
          let stat = agg.get(key);
          if (!stat) stat = { sum: 0, cnt: 0, last: '0000-00-00' };
          stat.sum  += avg;
          stat.cnt  += 1;
          if (d > stat.last) stat.last = d;
          agg.set(key, stat);
        }

        // 4) in Array umwandeln
        let rows = [];
        for (const [playerId, st] of agg.entries()) {
          const pl = pMap.get(playerId) || {
            full_name: playerId,
            club_name: '',
            positions: null,
            dominant_foot: null,
            birthdate: null
          };
          const avg = st.sum / st.cnt;
          rows.push({
            id:    playerId,
            name:  pl.full_name,
            club:  pl.club_name || '',
            pos:   pl.positions || null,
            foot:  pl.dominant_foot || '',
            birth: pl.birthdate || '',
            cnt:   st.cnt,
            avg,
            last:  st.last
          });
        }

        // 5) Filter auf Spielerebene anwenden
        rows = rows.filter(r => {
          const matchClub = !clubF || r.club === clubF;

          const posArr = Array.isArray(r.pos)
            ? r.pos
            : (typeof r.pos === 'string' && r.pos.length
                ? r.pos.split(',').map(x => x.trim()).filter(Boolean)
                : []);

          const matchPos  = !posF || posArr.includes(posF);
          const matchFoot = !footF || r.foot === footF;
          const matchText = !q || r.name.toLowerCase().includes(q) || r.club.toLowerCase().includes(q);
          const matchCnt  = r.cnt >= minR;
          const matchFav  = (favMode !== 'fav' || favSet.has(r.id));

          return matchClub && matchPos && matchFoot && matchText && matchCnt && matchFav;
        });

        // 6) Sortierung & Top 10
        rows.sort((a, b) => (a.avg - b.avg) || (b.cnt - a.cnt));
        if (topOnly) rows = rows.slice(0, 10);

        lastRows = rows.slice();

        if (!rows.length) {
          tbody.innerHTML = '<tr><td colspan="8">Keine Spieler f√ºr die aktuellen Filter gefunden.</td></tr>';
          if (msg) msg.textContent = 'Keine Spieler ‚Äì ggf. Filter zur√ºcksetzen oder mehr Bewertungen speichern.';
          return;
        }

        // 7) Tabelle rendern
        const footLabel = f =>
          f === 'left' ? 'links' :
          f === 'right' ? 'rechts' :
          f === 'both' ? 'beidf√º√üig' : '';

        const posStr = p =>
          Array.isArray(p) ? p.join(', ') :
          (typeof p === 'string' ? p : '');

        tbody.innerHTML = rows.map(r => {
          const star = favSet.has(r.id) ? '‚òÖ' : '‚òÜ';
          return `
            <tr data-pid="${r.id}">
              <td><span class="fav-toggle" data-pid="${r.id}" title="Watchlist an/aus">${star}</span></td>
              <td>${r.name}</td>
              <td>${r.club}</td>
              <td>${posStr(r.pos)}</td>
              <td>${footLabel(r.foot)}</td>
              <td>${r.cnt}</td>
              <td>${r.avg.toFixed(2)}</td>
              <td>${r.last || ''}</td>
            </tr>
          `;
        }).join('');

        // Watchlist-Klick
        tbody.querySelectorAll('.fav-toggle').forEach(el => {
          el.addEventListener('click', ev => {
            ev.stopPropagation();
            const pid = el.getAttribute('data-pid');
            if (!pid) return;
            if (favSet.has(pid)) favSet.delete(pid);
            else favSet.add(pid);
            saveFavSet(favSet);
            refreshRanking();
          });
        });

        // Zeilen-Klick ‚Üí Detailpopup
        tbody.onclick = (ev) => {
          const tr = ev.target.closest('tr[data-pid]');
          if (!tr) return;
          if (ev.target.classList.contains('fav-toggle')) return;

          const pid = tr.getAttribute('data-pid');
          const row = lastRows.find(r => String(r.id) === String(pid));
          if (!row) return;

          const pl = pMap.get(row.id) || {};
          const birthStr = pl.birthdate || '-';
          const footVal  = pl.dominant_foot || row.foot || '';
          const footL    = footLabel(footVal);
          const posS     = posStr(row.pos);

          const details = ratingsByPlayer.get(row.id) || [];
          let detailText = '';

          if (details.length) {
            detailText =
              '\n\nEinzelbewertungen:\n' +
              details.map(d => {
                const date  = (d.event_date || '').slice(0,10);
                const typeShort =
                  d.event_type === 'match'      ? 'Sp.' :
                  d.event_type === 'training'   ? 'Tr.' :
                  d.event_type === 'tournament' ? 'Tu.' :
                  (d.event_type || '');
                const pairing = d.event_name || '';
                const role    = d.role  || '';
                const rater   = d.rater || '';
                const rShort  = rater.includes('@') ? rater.split('@')[0] : rater;
                return `- ${date} ${typeShort} ${pairing} | √ò ${d.avg.toFixed(2)} | Rolle: ${role} | Bew.: ${rShort}`;
              }).join('\n');
          } else {
            detailText = '\n\nKeine Einzelbewertungen gefunden.';
          }

          alert(
            'Spieler: '      + row.name + '\n' +
            'Geb.: '         + birthStr + '\n' +
            'Verein: '       + row.club + '\n' +
            'Position(en): ' + posS + '\n' +
            'Fu√ü: '          + (footL || '-') + '\n' +
            'Bewertungen: '  + row.cnt + '\n' +
            '√ò Note: '       + row.avg.toFixed(2) +
            detailText
          );
        };

        if (msg) msg.textContent = `OK: ${rows.length} Spieler im Ranking.`;
      } catch (e) {
        console.error('refreshRanking', e);
        const msg = document.querySelector('#rank-msg');
        if (msg) msg.textContent = 'Fehler beim Laden des Rankings.';
        const tbody = document.querySelector('#rank-table tbody');
        if (tbody) tbody.innerHTML = '<tr><td colspan="8">Fehler beim Laden des Rankings.</td></tr>';
      }
    }

    ['change', 'input'].forEach(evt => {
      [
        'club-filter',
        'rank-pos',
        'rank-foot',
        'rank-type',
        'rank-role',
        'rank-from',
        'rank-to',
        'rank-min',
        'rank-q',
        'fav-filter',
        'rank-top10'
      ].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener(evt, () => refreshRanking());
      });
    });
    document.getElementById('btn-refresh-ranking')?.addEventListener('click', () => refreshRanking());

    document.getElementById('btn-export-csv')?.addEventListener('click', () => {
      if (!lastRows.length) return;
      const header = ['Spieler','Verein','Position(en)','Fu√ü','#Bewertungen','√ò Note','Letztes Event'];
      const lines = [
        header.join(';'),
        ...lastRows.map(r =>
          [
            r.name,
            r.club,
            Array.isArray(r.pos) ? r.pos.join(', ') : (r.pos || ''),
            (r.foot === 'left' ? 'links' : r.foot === 'right' ? 'rechts' : r.foot === 'both' ? 'beidf√º√üig' : ''),
            r.cnt,
            r.avg.toFixed(2),
            r.last || ''
          ].join(';')
        )
      ];
      const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'ranking.csv';
      a.click();
      URL.revokeObjectURL(url);
    });

    function parseICS(txt) {
      const out = [];
      const blocks = txt.split(/BEGIN:VEVENT/).slice(1).map(s => 'BEGIN:VEVENT' + s);
      for (const block of blocks) {
        const get = (k) => {
          const re = new RegExp('^' + k + '(?:;[^:]+)?:\\s*(.+)$','m');
          const m  = block.match(re);
          return m ? m[1].trim() : null;
        };
        let dt = get('DTSTART');
        if (!dt) {
          const m = block.match(/^DTSTART(?:;TZID=[^:]+)?:([0-9T]+)/m);
          if (m) dt = m[1];
        }
        if (!dt) continue;
        const raw = dt.replace(/[^0-9]/g,'').slice(0,8);
        if (raw.length < 8) continue;
        const event_date = `${raw.slice(0,4)}-${raw.slice(4,6)}-${raw.slice(6,8)}`;
        const summary  = get('SUMMARY')  || '';
        const location = get('LOCATION') || '';
        out.push({
          event_date,
          type:'match',
          subtype: summary.slice(0,120),
          competition:null,
          age_group:null,
          opponent:null,
          location:location.slice(0,120)
        });
      }
      return out;
    }

    document.getElementById('btn-import-ics')?.addEventListener('click', async () => {
      const c = await getClient().catch(e => {
        const m = $('#ics-msg');
        if (m) m.textContent = 'Nicht verbunden.';
        return null;
      });
      if (!c) return;
      const fileInput = document.getElementById('ics-file');
      const msg = document.getElementById('ics-msg');
      const file = fileInput?.files?.[0];
      if (!file) { if (msg) msg.textContent = 'Bitte eine .ics-Datei w√§hlen.'; return; }
      try {
        const txt = await file.text();
        const events = parseICS(txt);
        if (!events.length) { if (msg) msg.textContent = 'Keine VEVENTs gefunden.'; return; }
        const { error } = await c.from('event').insert(events);
        if (error) { console.error(error); if (msg) msg.textContent = 'Fehler: ' + error.message; }
        else { if (msg) msg.textContent = `OK ‚Äì ${events.length} Events importiert.`; refreshEvents(); }
      } catch (e) {
        console.error(e);
        const msg = document.getElementById('ics-msg');
        if (msg) msg.textContent = 'Fehler beim Import.';
      }
    });

    document.getElementById('btn-import-ics-url')?.addEventListener('click', async () => {
      const c = await getClient().catch(e => {
        const m = $('#ics-msg');
        if (m) m.textContent = 'Nicht verbunden.';
        return null;
      });
      if (!c) return;
      const msg  = document.getElementById('ics-msg');
      const url  = (document.getElementById('ics-url')?.value || '').trim();
      if (!url) { if (msg) msg.textContent = 'Bitte eine ICS-URL eingeben.'; return; }
      try {
        const res = await fetch(url, { redirect:'follow' });
        if (!res.ok) throw new Error(res.statusText);
        const txt = await res.text();
        const events = parseICS(txt);
        if (!events.length) { if (msg) msg.textContent = 'Keine VEVENTs gefunden.'; return; }
        const { error } = await c.from('event').insert(events);
        if (error) { console.error(error); if (msg) msg.textContent = 'Fehler: ' + error.message; }
        else { if (msg) msg.textContent = `OK ‚Äì ${events.length} Events importiert.`; refreshEvents(); }
      } catch (e) {
        console.error(e);
        if (msg) msg.textContent = 'Fehler beim Laden. Nutze ggf. Download + Datei-Import.';
      }
    });

    async function refreshLastComments() {
      try {
        const c = await getClient();
        const { data, error } = await c
          .from('rating')
          .select('id, player_id, event_id, comment, created_at')
          .order('created_at', { ascending:false })
          .limit(5);
        if (error) throw error;
        const pMap = new Map();
        const eMap = new Map();
        const idsP = Array.from(new Set((data||[]).map(r => r.player_id).filter(Boolean)));
        const idsE = Array.from(new Set((data||[]).map(r => r.event_id).filter(Boolean)));
        if (idsP.length) {
          const pr = await c.from('player').select('id, full_name').in('id', idsP);
          (pr.data||[]).forEach(p => pMap.set(p.id, p.full_name));
        }
        if (idsE.length) {
          const er = await c.from('event').select('id, event_date, subtype, competition, opponent').in('id', idsE);
          (er.data||[]).forEach(ev => {
            let name = '';
            if (ev.competition || ev.opponent) {
              name = `${ev.competition || ''} - ${ev.opponent || ''}`.trim();
            } else if (ev.subtype) {
              name = ev.subtype;
            } else {
              name = ev.event_date || '';
            }
            eMap.set(ev.id, `${ev.event_date || ''} ${name}`);
          });
        }
        const box = document.getElementById('last-ratings');
        if (!box) return;
        box.innerHTML = (data||[]).length
          ? (data||[]).map(r =>
              `<tr>
                <td>${(r.created_at||'').slice(0,10)}</td>
                <td>${pMap.get(r.player_id) || r.player_id}</td>
                <td>${eMap.get(r.event_id) || ''}</td>
                <td>${(r.comment || '').substring(0,120)}</td>
              </tr>`
            ).join('')
          : '<tr><td colspan="4">Noch keine Bewertungen.</td></tr>';
      } catch (e) {
        console.error('refreshLastComments', e);
      }
    }

    async function createEvent() {
      const dateEl   = document.getElementById('event-date');
      const typeEl   = document.getElementById('event-type');
      const homeEl   = document.getElementById('event-home');
      const awayEl   = document.getElementById('event-away');
      const nameEl   = document.getElementById('event-name');
      const locEl    = document.getElementById('event-location');
      const msg      = document.getElementById('event-create-msg');

      if (!currentUser) {
        if (msg) msg.textContent = 'Bitte zuerst einloggen.';
        return;
      }
      if (isMinorLocked()) {
        if (msg) msg.textContent = 'Dein Konto ist noch nicht freigeschaltet (Elternzustimmung fehlt).';
        return;
      }

      const event_date = (dateEl?.value || '').trim();
      const type       = (typeEl?.value || '').trim();

      const competition = (homeEl?.value || '').trim();
      const opponent    = (awayEl?.value || '').trim();
      const subtype     = (nameEl?.value || '').trim();
      const location    = (locEl?.value || '').trim();

      if (!event_date || !type) {
        if (msg) msg.textContent = 'Bitte mindestens Datum und Event-Typ eingeben.';
        return;
      }

      try {
        const c = await getClient();

        const { data, error } = await c
          .from('event')
          .insert([{
            event_date,
            type,
            competition,
            opponent,
            subtype,
            location
          }])
          .select();

        if (error) {
          console.error('createEvent error', error);
          if (msg) msg.textContent = 'Fehler beim Speichern: ' + error.message;
          return;
        }

        if (msg) msg.textContent = 'Event gespeichert.';

        if (homeEl) homeEl.value = '';
        if (awayEl) awayEl.value = '';
        if (nameEl) nameEl.value = '';
        if (locEl)  locEl.value  = '';

        await refreshEvents();
        if (data && data.length) {
          setCurrentEvent(data[0]);
        }
      } catch (e) {
        console.error('createEvent', e);
        if (msg) msg.textContent = 'Fehler beim Speichern.';
      }
    }

    document.getElementById('btn-create-event')?.addEventListener('click', createEvent);
   
    // -----------------------------
    // SpielerRadar‚Ñ¢ ‚Äì Live-Aktionen
    // -----------------------------
    let currentRadar = null;
    let currentRadarPlayerId = null;

    // Drei feste Farben f√ºr die Watchlist-Slots
    const radarColors = ['#fff4db', '#e3f3ff', '#e8ffe5'];

    // Watchlist (max. 3 Spieler)
    // Struktur: { playerId, playerName, teamName, colorIndex }
    let radarWatchlist = [];
    const wlBox = () => document.getElementById('radar-watchlist');

    async function radarLoadEventsForRadar() {
      const sel = document.getElementById('radar-event-select');
      const statusEl = document.getElementById('radar-status');
      if (!sel) return;
      try {
        const c = await getClient();
        const { data, error } = await c
          .from('event')
          .select('id, event_date, type, competition, opponent, subtype, location')
          .order('event_date', { ascending: true });
        if (error) throw error;

        sel.innerHTML = '<option value="">Bitte w√§hlen ‚Ä¶</option>';
        (data || []).forEach(ev => {
          const opt = document.createElement('option');
          opt.value = ev.id;
          opt.textContent = formatEventDisplayLine(ev);
          sel.appendChild(opt);
        });

        if (statusEl) statusEl.textContent = 'Events f√ºr SpielerRadar geladen.';
      } catch (e) {
        console.error('radarLoadEventsForRadar', e);
        if (statusEl) statusEl.textContent = 'Fehler beim Laden der Events f√ºr SpielerRadar.';
      }
    }

    async function radarLoadPlayersForRadar() {
      const sel = document.getElementById('radar-player-select');
      const statusEl = document.getElementById('radar-status');
      if (!sel) return;

      try {
        const c = await getClient();
        const { data, error } = await c
          .from('player')
          .select('id, full_name, club_name, positions, jersey_number')
          .order('full_name', { ascending: true });

        if (error) throw error;

        // Dropdown leeren und Standard-Option setzen
        sel.innerHTML = '<option value="">Bitte w√§hlen ‚Ä¶</option>';

        // Alle Spieler einf√ºgen
        (data || []).forEach(pl => {
          const club = pl.club_name || '';
          const pos = (pl.positions && pl.positions.length)
            ? ` [${pl.positions.join(', ')}]`
            : '';
          const num = pl.jersey_number ? `#${pl.jersey_number} ` : '';
          const opt = document.createElement('option');
          opt.value = pl.id;
          opt.textContent = `${num}${pl.full_name} (${club})${pos}`;
          if (club) opt.dataset.club = club;
          if (pl.jersey_number != null) opt.dataset.number = pl.jersey_number;
          sel.appendChild(opt);
        });

        if (statusEl) statusEl.textContent = 'Spieler f√ºr SpielerRadar geladen.';
      } catch (e) {
        console.error('radarLoadPlayersForRadar', e);
        if (statusEl) statusEl.textContent = 'Fehler beim Laden der Spieler f√ºr SpielerRadar.';
      }
    }

    // Watchlist-Tabs rendern
    function radarRenderWatchlist() {
      const box = wlBox();
      if (!box) return;
      box.innerHTML = '';

      radarWatchlist.forEach(item => {
        const btn = document.createElement('button');
        btn.className = 'radar-tab';

        const color = radarColors[item.colorIndex] || radarColors[0];
        btn.style.backgroundColor = color;

        // Inhalt neu aufbauen
        btn.innerHTML = '';

        // Trikot-Badge mit Nummer
        if (item.jerseyNumber) {
          const badge = document.createElement('span');
          badge.className = 'jersey-badge';
          badge.textContent = item.jerseyNumber;
          badge.style.marginRight = '6px';
          btn.appendChild(badge);
        }

        // Spielername
        const textSpan = document.createElement('span');
        textSpan.textContent = item.playerName;
        btn.appendChild(textSpan);

        // aktiven Spieler markieren
        if (item.playerId === currentRadarPlayerId) {
          btn.classList.add('active');
          btn.style.boxShadow = '0 0 0 2px rgba(0,0,0,0.08)';
        } else {
          btn.classList.remove('active');
          btn.style.boxShadow = 'none';
        }

        btn.addEventListener('click', () => {
          radarLoadPlayerFromWatchlist(item.playerId);
        });

        box.appendChild(btn);
      });
    }

    // Spieler aus Watchlist w√§hlen ‚Üí Dropdown setzen ‚Üí Radar starten
    function radarLoadPlayerFromWatchlist(playerId) {
      const playerSel = document.getElementById('radar-player-select');
      if (!playerSel) return;
      const opt = playerSel.querySelector(`option[value="${playerId}"]`);
      if (opt) {
        playerSel.value = playerId;
      }
      radarStartOrLoad();
    }

    // Spieler zur Watchlist hinzuf√ºgen (max. 3)
    function radarAddToWatchlist() {
      const playerSel = document.getElementById('radar-player-select');
      const eventSel  = document.getElementById('radar-event-select');
      const status    = document.getElementById('radar-status');

      if (!eventSel.value) {
        if (status) status.textContent = 'Bitte zuerst ein Event w√§hlen.';
        return;
      }
      if (!playerSel.value) {
        if (status) status.textContent = 'Bitte einen Spieler w√§hlen.';
        return;
      }

      const opt = playerSel.options[playerSel.selectedIndex];
      const playerId = opt.value;
      const playerName = opt.textContent;
      const teamName = opt.dataset.club || null;
      const jerseyNumber = opt.dataset.number ? parseInt(opt.dataset.number, 10) : null;

      if (radarWatchlist.length >= 3) {
        if (status) status.textContent = 'Maximal 3 Spieler in der Watchlist.';
        return;
      }
      if (radarWatchlist.some(p => p.playerId === playerId)) {
        if (status) status.textContent = 'Spieler ist bereits in der Watchlist.';
        return;
      }

      const colorIndex = radarWatchlist.length % radarColors.length;

      radarWatchlist.push({ playerId, playerName, teamName, colorIndex, jerseyNumber });
      radarRenderWatchlist();

      if (status) status.textContent = `Spieler ${playerName} zur Watchlist hinzugef√ºgt.`;
    }

    function radarUpdateScoresUI() {
      if (!currentRadar) return;
      const fields = [
        'ballsicherheit',
        'zweikampf',
        'laufduell',
        'abschluss',
        'standard',
        'mentalitaet',
        'fairplay'
      ];
      fields.forEach(field => {
        const plus = currentRadar[`${field}_plus`] || 0;
        const minus = currentRadar[`${field}_minus`] || 0;
        const netto = plus - minus;
        const span = document.querySelector(`.radar-score[data-field="${field}"]`);
        if (span) {
          span.textContent = `Netto: ${netto} ( +${plus} / ‚àí${minus} )`;
        }
      });
    }

    async function radarStartOrLoad() {
      const statusEl    = document.getElementById('radar-status');
      const panel       = document.getElementById('radar-panel');
      const eventSel    = document.getElementById('radar-event-select');
      const playerSel   = document.getElementById('radar-player-select');
      const playerLabel = document.getElementById('radar-player-label');

      if (!eventSel || !playerSel) return;

      const eventId  = eventSel.value || '';
      const playerId = playerSel.value || '';

      if (!currentUser) {
        if (statusEl) statusEl.textContent = 'Bitte zuerst einloggen.';
        if (panel) panel.style.display = 'none';
        return;
      }
      if (isMinorLocked()) {
        if (statusEl) statusEl.textContent = 'Dein Konto ist noch nicht freigeschaltet (Elternzustimmung fehlt).';
        if (panel) panel.style.display = 'none';
        return;
      }
      if (!eventId || !playerId) {
        if (statusEl) statusEl.textContent = 'Bitte Event und Spieler ausw√§hlen.';
        if (panel) panel.style.display = 'none';
        return;
      }

      try {
        const c = await getClient();
        const evaluatorId = currentUser.id;
        const playerOption   = playerSel.options[playerSel.selectedIndex];
        const playerTeamName = playerOption?.dataset?.club || null;
        const evaluatorTeamName = currentProfile?.club_name || null;

        // vorhandenen Datensatz laden
        let { data, error } = await c
          .from('player_radar')
          .select('*')
          .eq('event_id', eventId)
          .eq('rated_player_id', playerId)
          .eq('evaluator_user_id', evaluatorId)
          .maybeSingle();

        if (error) throw error;

        // falls noch keiner, neuen Datensatz anlegen
        if (!data) {
          const ins = await c
            .from('player_radar')
            .insert({
              event_id: eventId,
              rated_player_id: playerId,
              evaluator_user_id: evaluatorId,
              player_team_name: playerTeamName,
              evaluator_team_name: evaluatorTeamName
            })
            .select('*')
            .single();

          if (ins.error) throw ins.error;
          data = ins.data;
        }

        currentRadar = data;
        currentRadarPlayerId = playerId;

        radarUpdateScoresUI();

        // aktiven Watchlist-Eintrag suchen ‚Üí Farbe holen
        const activeItem = radarWatchlist.find(p => p.playerId === playerId);
        const panelColor = activeItem
          ? (radarColors[activeItem.colorIndex] || '#fff9dd')
          : '#fff9dd';

        if (panel) {
          panel.style.display = 'block';
          panel.style.backgroundColor = panelColor;
          panel.style.borderTop = '1px solid ' + panelColor;
        }

        // Tabs neu zeichnen (damit dort auch der aktive Spieler markiert ist)
        radarRenderWatchlist();

        if (playerLabel) {
          playerLabel.textContent = `Live-Aktionen: ${playerOption.textContent}`;
        }
        if (statusEl) statusEl.textContent = 'SpielerRadar aktiv ‚Äì Aktionen k√∂nnen erfasst werden.';

        // Ranking f√ºr dieses Spiel aktualisieren, falls vorhanden
        if (typeof radarRefreshSummary === 'function') {
          await radarRefreshSummary();
        }
      } catch (e) {
        console.error('radarStartOrLoad', e);
        if (statusEl) statusEl.textContent = 'Fehler beim Starten des SpielerRadars.';
        if (panel) panel.style.display = 'none';
      }
    }

    async function radarHandleButtonClick(field, isPlus) {
      if (!currentRadar) return;
      const statusEl = document.getElementById('radar-status');
      const plusField = `${field}_plus`;
      const minusField = `${field}_minus`;
      const updates = {};

      if (isPlus) {
        updates[plusField] = (currentRadar[plusField] || 0) + 1;
      } else {
        updates[minusField] = (currentRadar[minusField] || 0) + 1;
      }

      try {
        const c = await getClient();
        const { data, error } = await c
          .from('player_radar')
          .update(updates)
          .eq('id', currentRadar.id)
          .select('*')
          .single();
        if (error) throw error;
        currentRadar = data;
        radarUpdateScoresUI();
        if (statusEl) statusEl.textContent = 'Aktion erfasst.';
        await radarRefreshSummary();
      } catch (e) {
        console.error('radarHandleButtonClick', e);
        if (statusEl) statusEl.textContent = 'Fehler beim Speichern der Aktion.';
      }
    }

    function radarInitUI() {
      const eventSel = document.getElementById('radar-event-select');
      const playerSel = document.getElementById('radar-player-select');
      const startBtn = document.getElementById('radar-start-btn');
      const addBtn = document.getElementById('radar-add-to-watchlist');
      if (!eventSel || !playerSel || !startBtn) return;

      radarLoadEventsForRadar();
      radarLoadPlayersForRadar();

      startBtn.addEventListener('click', radarStartOrLoad);
      if (addBtn) addBtn.addEventListener('click', radarAddToWatchlist);

      document.querySelectorAll('.radar-btn-plus').forEach(btn => {
        btn.addEventListener('click', () => {
          const field = btn.getAttribute('data-field');
          radarHandleButtonClick(field, true);
        });
      });
      document.querySelectorAll('.radar-btn-minus').forEach(btn => {
        btn.addEventListener('click', () => {
          const field = btn.getAttribute('data-field');
          radarHandleButtonClick(field, false);
        });
      });
    }
    
        async function radarRefreshSummary() {
      const tbody = document.querySelector('#radar-summary-table tbody');
      const msg = document.getElementById('radar-summary-msg');
      const eventSel = document.getElementById('radar-event-select');

      if (!tbody || !eventSel || !currentUser) return;

      const eventId = eventSel.value;
      if (!eventId) {
        tbody.innerHTML = '<tr><td colspan="9">Bitte zuerst ein Event w√§hlen.</td></tr>';
        if (msg) msg.textContent = '';
        return;
      }

      const playerIds = radarWatchlist.map(p => p.playerId);
      if (!playerIds.length) {
        tbody.innerHTML = '<tr><td colspan="9">Keine Spieler in der Watchlist.</td></tr>';
        if (msg) msg.textContent = '';
        return;
      }

      try {
        const c = await getClient();
        let query = c
          .from('player_radar')
          .select('*')
          .eq('event_id', eventId)
          .eq('evaluator_user_id', currentUser.id)
          .in('rated_player_id', playerIds);

        const { data, error } = await query;
        if (error) throw error;

        if (!data || !data.length) {
          tbody.innerHTML = '<tr><td colspan="9">Noch keine Radar-Daten erfasst.</td></tr>';
          if (msg) msg.textContent = '';
          return;
        }

        const wlMap = new Map(radarWatchlist.map(p => [p.playerId, p]));

        const rows = data.map(row => {
          const nets = f => (row[`${f}_plus`] || 0) - (row[`${f}_minus`] || 0);
          return {
            playerId: row.rated_player_id,
            // alle Feldnamen exakt wie in der Tabelle:
            ballsich:  nets('ballsicherheit'),
            zweik:     nets('zweikampf'),
            lauf:      nets('laufduell'),
            abschluss: nets('abschluss'),
            std:       nets('standard'),
            ment:      nets('mentalitaet'),
            fair:      nets('fairplay'),
            total:     nets('ballsicherheit') +
                       nets('zweikampf') +
                       nets('laufduell') +
                       nets('abschluss') +
                       nets('standard') +
                       nets('mentalitaet') +
                       nets('fairplay')
          };
        });

        rows.sort((a, b) => b.total - a.total);

        tbody.innerHTML = rows.map(r => {
          const wl = wlMap.get(r.playerId);
          const label = wl ? wl.playerName : r.playerId;
          const color = wl ? radarColors[wl.colorIndex] : '#eee';
          const active = r.playerId === currentRadarPlayerId ? 'font-weight:600;' : '';

          return `
            <tr style="background:${color};${active}">
              <td>${label}</td>
              <td>${r.total}</td>
              <td>${r.ballsich}</td>
              <td>${r.zweik}</td>
              <td>${r.lauf}</td>
              <td>${r.abschluss}</td>
              <td>${r.std}</td>
              <td>${r.ment}</td>
              <td>${r.fair}</td>
            </tr>
          `;
        }).join('');

        if (msg) msg.textContent = `Radar-Ranking f√ºr ${rows.length} Spieler geladen.`;

      } catch (e) {
        console.error('radarRefreshSummary', e);
        tbody.innerHTML = '<tr><td colspan="9">Fehler beim Laden.</td></tr>';
        if (msg) msg.textContent = 'Fehler beim Ranking.';
      }
    }

    radarInitUI();

    // Hilfsfunktion: Radar-Dropdowns neu laden (Event + Spieler)
    async function radarRefreshData() {
      const eventSel  = document.getElementById('radar-event-select');
      const playerSel = document.getElementById('radar-player-select');

      // Wenn der Radar-Reiter im HTML noch nicht existiert, einfach nichts tun
      if (!eventSel || !playerSel) return;

      await Promise.all([
        radarLoadEventsForRadar(),
        radarLoadPlayersForRadar()
      ]);
    }
 
    // -----------------------------
    // Daten-Init nach Login
    // -----------------------------
        async function refreshAllData() {
      await Promise.all([refreshPlayers(), refreshEvents(), refreshClubFilter()]);
      await refreshRanking();
      await refreshLastComments();

      // Nur aufrufen, wenn die Funktion existiert (zus√§tzliche Sicherheit)
      if (typeof radarRefreshData === 'function') {
        await radarRefreshData();
      }
    }
   
    // -----------------------------
    // Funktionen f√ºr Navigation von au√üen verf√ºgbar machen
    // -----------------------------
    window.refreshRanking = refreshRanking;
    window.refreshLastComments = refreshLastComments;

    
    (async function init() {
      const cfg = loadConfig();
      const urlInput = document.getElementById('sb-url');
      const keyInput = document.getElementById('sb-key');
      if (urlInput) urlInput.value = cfg.url;
      if (keyInput) keyInput.value = cfg.key;

      if (cfg.url && cfg.key) {
        try {
          await getClient();
          const rankMsg = $('#rank-msg');
          if (rankMsg) rankMsg.textContent = 'Bereit (bitte einloggen).';
          if (window.npShowSection) {
            window.npShowSection('sec-auth');
          }
        } catch (e) {
          console.error('init', e);
        }
      }
    })();
  </script>
</body>
</html>
